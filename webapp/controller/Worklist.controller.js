/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["cross/fnd/fiori/inbox/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","cross/fnd/fiori/inbox/model/formatter","cross/fnd/fiori/inbox/model/models","cross/fnd/fiori/inbox/model/ModelsHelper","cross/fnd/fiori/inbox/util/TaskHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/TablePersoController","sap/m/MessageToast","cross/fnd/fiori/inbox/util/TableOperationsMyTasks","cross/fnd/fiori/inbox/util/TableOperationsHelper","cross/fnd/fiori/inbox/util/IconTabBarHelper","sap/base/Log","cross/fnd/fiori/inbox/util/StartupParameters","sap/ui/Device","cross/fnd/fiori/inbox/util/Utils","sap/ui/core/ResizeHandler","cross/fnd/fiori/inbox/util/TaskListCustomAttributeHelperMyTasks","cross/fnd/fiori/inbox/util/Constants","cross/fnd/fiori/inbox/util/FilterBarHelper","cross/fnd/fiori/inbox/util/ResponseOptionsHelper"],function(B,J,H,f,m,M,T,F,a,b,c,d,e,I,L,S,D,U,R,g,C,h,j){"use strict";return B.extend("cross.fnd.fiori.inbox.controller.Worklist",{formatter:f,oSelectedTasksDetails:null,oMultiSelectMessageDialogView:null,OriginsToDisplayNameDictionary:{},onInit:function(){var v,o,t=this.byId("table");this._oPage=this.byId("page");this._oTable=t;this.oRouter=this.getOwnerComponent().getRouter();this._oFilterBar=this.byId("filterBar");this._aCustomStringAttributes=[];this._bApplyingFilters=false;this.oStartupParameters=S.getInstance();o=t.getBusyIndicatorDelay();this._aTableSearchState=[];this._offlineSystems=[];v=new J({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),tableNoDataText:this.getResourceBundle().getText("tableLoading"),tableCustomAttributeLimitInfoMessage:this.getResourceBundle().getText("tableCustomAttributeLimitInfo"),personalizationActive:false,tableBusyDelay:0,refreshButtonEnabled:false,refreshButtonPressed:false,iconTabBarVisible:false,tableVisible:false,actionsColumnBusy:false,connectionErrorMessageVisible:false,caLimitInfoVisible:false,connectionErrorMessage:"",columnListItemType:"Active",caFilteringByOnlyForOneTaskTypeMessage:this.getResourceBundle().getText("caFilteringOnlyForOneTaskType"),caFilteringInfoVisible:false,caShowCustomFilters:false});this.setModel(v,"worklistView");this.setModel(m.getFilterTabsModel(),"filterTabsModel");this.setModel(m.getTaskTypesModel(),"taskTypesModel");m.setMainModel(this.getOwnerComponent().getModel());this._oPage.setBusyIndicatorDelay(0);this._oPage.setBusy(true);this._bSystemInfoExists=false;this._oTableOperations=new d(this._oTable);this._taskListCustomAttributeHelper=new g(this,this.getView(),this.byId("table"),this._oTableOperations);this._oTableOperationsHelper=new e(this._oTableOperations,this.getView(),this._taskListCustomAttributeHelper);this._oTableOperationsHelper.setColumnSortIndicator("createdOnColumn","Descending");this._oFilterBarHelper=new h(this._oTableOperations,this._oFilterBar,this.getView(),this._taskListCustomAttributeHelper,this._oTableOperationsHelper);this._initializeFilterModel();this._oIconTabBarHelper=new I(this._oTableOperations,this.getView());var i=this;m.getMainModel().getMetaModel().loaded().then(function(){m.refreshTaskDefinitionModel();if(m.checkPropertyExistsInMetadata("SystemInfoCollection",null)){i._bSystemInfoExists=true;m.refreshSystemInfoModel();}else{i._oIconTabBarHelper.createTabsAndFilters();i._oIconTabBarHelper.prepareRequestsforTabCounts();i._oTableOperations.setAppFilters(i._oIconTabBarHelper.getTabFilterForKey("All"));i._oTableOperations.applyTableOperations("TabCountsBatchGrp");}});m.attachEvent("taskModelUpdated",null,function(){this.setModel(m.getTaskModel(),"taskModel");if(this._oTableOperations.isGroupingChanged()){this._oTable.getBinding("items").sort(this._oTableOperations.getSortGroupList());}else{this._oTable.getBinding("items").sort();}if(this._oTableOperations.getUserFilters().length===0&&!this._oTableOperations.getURLParameters().hasOwnProperty("searchText")){this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("tableNoDataText"));}this._oPage.setBusy(false);if(this.getModel("worklistView").getProperty("/refreshButtonPressed")){this.getModel("worklistView").setProperty("/refreshButtonPressed",false);if(this._offlineSystems.length<=0){c.show(this.getResourceBundle().getText("refreshTaskListSuccess"));}}this.getModel("worklistView").setProperty("/refreshButtonEnabled",true);this.getModel("worklistView").setProperty("/actionsColumnBusy",false);this.getModel("worklistView").setProperty("/iconTabBarVisible",true);this.getModel("worklistView").setProperty("/tableVisible",true);if(this._bApplyingFilters){this._bApplyingFilters=false;this._selectFirstFilteredTask();}},this);m.attachEvent("taskModelUpdateError",null,function(){this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("tableNoDataText"));this._oPage.setBusy(false);this.getModel("worklistView").setProperty("/refreshButtonEnabled",true);this.getModel("worklistView").setProperty("/iconTabBarVisible",true);this.getModel("worklistView").setProperty("/tableVisible",true);},this);m.attachEvent("systemInfoModelUpdated",null,function(){var s=m.getSystemInfoModel().getData().results;this._oIconTabBarHelper.createTabsAndFilters(s);this.createOriginsToDisplayNameDictionary(s);this._offlineSystems=m.getSystemInfoModel().getProperty("/offlineSystems");if(this._oIconTabBarHelper.selectedTabKey==="All"){this._oIconTabBarHelper.prepareRequestsforTabCounts();}else{this._oIconTabBarHelper.prepareRequestforSingleTabCounts(this._oIconTabBarHelper.selectedTabKey);}this._oTableOperations.setAppFilters(this._oIconTabBarHelper.getTabFilterForKey(this._oIconTabBarHelper.selectedTabKey));this._oTableOperations.applyTableOperations("TabCountsBatchGrp");if(this._offlineSystems.length>0){var p=this._offlineSystems.join(", ");var l=this.getResourceBundle().getText("systemConnectionError",[p]);this.getModel("worklistView").setProperty("/connectionErrorMessage",l);this.getModel("worklistView").setProperty("/connectionErrorMessageVisible",true);}else{this.getModel("worklistView").setProperty("/connectionErrorMessageVisible",false);}},this);m.attachEvent("systemInfoModelUpdateError",null,function(){this._oPage.setBusy(false);},this);m.attachEvent("updateCustomActions",null,function(){this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(true);m.updateTaskModelWithCustomActions();},this);m.attachEvent("customActionsUpdated",null,function(){this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(false);this.getModel("worklistView").setProperty("/actionsColumnBusy",false);},this);m.attachEvent("customActionsUpdateError",null,function(){this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(false);this.getModel("worklistView").setProperty("/actionsColumnBusy",false);},this);m.attachEvent("customActionSuccess",null,function(E){if(E.getParameter("taskStatus")==="COMPLETED"){var l=E.getParameter("taskToRemove");var s=this._oIconTabBarHelper.selectedTabKey;var n=this._oIconTabBarHelper.getIconTabProperty(s,"count");var r;var p;if(s==="All"){r=this._oIconTabBarHelper.mSAP__OriginToIconTabID[l.SAP__Origin];p=this._oIconTabBarHelper.getIconTabProperty(r,"count");this._oIconTabBarHelper.setIconTabProperty("All","count",n-1);this._oIconTabBarHelper.setIconTabProperty(r,"count",p-1);}else{this._oIconTabBarHelper.setIconTabProperty(s,"count",n-1);p=this._oIconTabBarHelper.getIconTabProperty("All","count");this._oIconTabBarHelper.setIconTabProperty("All","count",p-1);}m.getFilterTabsModel().updateBindings();if(this.getOwnerComponent().getFCLHelper().getCurrentUIState().layout==="OneColumn"||j._bCompletedTaskIsDifferentFromDetail){return;}var q=this._oTable.getItems();if(q.length>0){var N=q[this._iPressedIndex];if(N){N.firePress();}else{q[this._iPressedIndex-1].firePress();}}else{this.oRouter.navTo("myTasksMaster",null,this.bReplaceHistory);}}c.show(this.getResourceBundle().getText("actionSuccessfullyExecuted"));},this);m.attachEvent("customActionError",null,function(E){this.openMessageDialog(E.getParameter("sCurrentAction"),E.getParameter("aSuccessList"),E.getParameter("aErrorList"),null,E.getParameter("aSelectedTasks"));},this);t.attachEventOnce("updateFinished",function(){v.setProperty("/tableBusyDelay",o);});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#taskcenter-display"},true);this._initPersonalization();this._initPlaceholderAndTooltip();if(this.oStartupParameters.isFlexibleColumnLayout()){this.getModel("worklistView").setProperty("/columnListItemType","Navigation");}this.getRouter().getRoute("myTasksMaster").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachRouteMatched(this._onRouteMatched,this);R.register(t,this.onResize.bind(this));var k=this.getOwnerComponent().getErrorHandler().getIsMetadataLoadedFailed();if(k){i._oPage.setBusy(false);}},onExit:function(){this.oStartupParameters.destroy();this.getRouter().detachRoutePatternMatched(this._onMasterMatched,this);this._oTablePersoController.destroy();this._oTableOperationsHelper.destroy();this._oTableOperations.destroy();m.destroy();},onUpdateStarted:function(E){L.debug("Started: "+JSON.stringify(E.getParameters()),"Worklist.controller.js","MyTasks");L.debug("Started: "+JSON.stringify(this._oTable.getGrowingInfo()),"Worklist.controller.js","MyTasks");var i=E.getParameter("reason").toLowerCase();if(i==="growing"){m.loadNextPageInTaskModel();}},onUpdateFinished:function(E){L.debug("Finished: "+JSON.stringify(E.getParameters()),"Worklist.controller.js","MyTasks");L.debug("Finished: "+JSON.stringify(this._oTable.getGrowingInfo()),"Worklist.controller.js","MyTasks");var i=this.byId("idIconTabBar");var k=E.getParameter("reason").toLowerCase();if((k==="change")||(k==="filter")||(k==="sort")){var l=0;var A=m.getTaskModel().getData().__count;if(A>=0){l=A;}var t;if(i.oSelectedTab){t=this.getCustomDataValues(i.oSelectedTab).count;}else{t=l;}this.setTableHeaderCounter(l,t);}},onPress:function(E){var i=E.getSource();var t;var u;if(i){t=i.getBindingContext("taskModel");if(!jQuery.isEmptyObject(i.getParent())&&typeof i.getParent().indexOfItem(i)!=="undefined"){this.iIndex=i.getParent().indexOfItem(i);}this._iPressedIndex=this._oTable.getItems().indexOf(i);j._sPressedItemContextPath=i.getBindingContextPath();}if(t){if(this.oStartupParameters.isFlexibleColumnLayout()){var k=t.getProperty("SAP__Origin");var l=t.getProperty("InstanceID");if(this.oLastNavigatedItem){this.oLastNavigatedItem.setNavigated(false);}this.oLastNavigatedItem=i.setNavigated(true);var n=this.getOwnerComponent().getFCLHelper().getNextUIState(1);var s=n.layout;this.oRouter.navTo("myTasksDetail",{SAP__Origin:encodeURIComponent(k),InstanceID:encodeURIComponent(l),layout:s},this.bReplaceHistory);}else{u=t.getProperty("GUI_Link");}}if(u){sap.m.URLHelper.redirect(u,true);}this.getModel("parametersModel").setProperty("/showLogButtonPressed",false);m.resetWorkflowLogModel();this.getModel("parametersModel").setProperty("/showDetailsButtonPressed",false);},onSearch:function(E){this.clearTaskListSelection();if(E.getParameters().refreshButtonPressed){this.onRefresh();}else{this._oFilterBarHelper.prepareSearch(E.getSource(),this._aCustomStringAttributes);var q=E.getParameter("query");if(q&&q.length>0){var s="";if(this._aCustomStringAttributes.length>0){s=", "+this._aCustomStringAttributes.join(", ");}this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchTextCustomAttributes")+s);this._oTableOperations.setURLParameter("searchText",q);}else{this._oTableOperations.removeURLParameter("searchText");}this._oTableOperations.applyTableOperations();this._oPage.getScrollDelegate().scrollTo(0,0,0);}},onRefresh:function(){var t=this.byId("table");t.getBinding("items").refresh();},_initPlaceholderAndTooltip:function(){if(this._aCustomStringAttributes.length>0){var s=this.getResourceBundle().getText("searchFieldPlaceholder")+", "+this._aCustomStringAttributes.join(', ');this.getModel("worklistView").setProperty("/searchFieldPlaceholder",s);this.getModel("worklistView").setProperty("/worklistSearchTooltip",s);}else{this.getModel("worklistView").setProperty("/searchFieldPlaceholder",this.getResourceBundle().getText("searchFieldPlaceholder"));this.getModel("worklistView").setProperty("/worklistSearchTooltip",this.getResourceBundle().getText("worklistSearchTooltip"));}},onResize:function(E){if(E.size.width<=640||(E.size.width>640&&D.system.phone)||(E.size.width>640&&E.size.width<900&&E.oldSize.width!==0&&E.oldSize.width<900&&D.system.tablet)){this.getModel("parametersModel").setProperty("/showCreatedByAvatar",false);this.getModel("parametersModel").setProperty("/widthNameColumn","");this.getModel("parametersModel").setProperty("/widthPriorityColumn","6rem");}else{this.getModel("parametersModel").setProperty("/showCreatedByAvatar",true);this.getModel("parametersModel").setProperty("/widthNameColumn","35%");this.getModel("parametersModel").setProperty("/widthPriorityColumn","");}},handleIconTabBarSelect:function(E){var i=this.byId("idIconTabBar"),s=E.getParameter("key");if((s)&&(i.oSelectedTab)&&(i.oSelectedTab.getProperty("key")!==s)){this._oPage.setBusy(true);i.oSelectedTab=E.getParameter("selectedItem");this._oIconTabBarHelper.selectedTabKey=s;this.clearTaskListSelection();this._oTableOperationsHelper.resetViewSettingsDialog();this._oFilterBarHelper.resetFilterBar();this._oTableOperations.setAppFilters(this._oIconTabBarHelper.getTabFilterForKey(s));this._bApplyingFilters=true;if(s==="All"){this._oIconTabBarHelper.prepareRequestsforTabCounts();}else{this._oIconTabBarHelper.prepareRequestforSingleTabCounts(s);}this._taskListCustomAttributeHelper.hideCustomAttributeColumns();this._oTableOperations.removeURLParameter("searchText");this._oTableOperations.applyTableOperations("TabCountsBatchGrp");this._oIconTabBarHelper.updateTaskTypesListForTab(s);}},onClearFilters:function(E){this._oFilterBarHelper.resetFilterBar();this._oTableOperations.setURLParameter("searchText","");this._oFilterBarHelper.applyFilters(E);},_initPersonalization:function(){var p=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService&&sap.ushell.Container.getService("Personalization");if(p){var P=p.getPersonalizer({container:"cross.fnd.fiori.inbox.Table",item:"worklistTable"});this._oTablePersoController=new sap.m.TablePersoController("PersoID",{table:this._oTable,componentName:"table",persoService:P,showResetAll:false}).activate();}this.getView().getModel("worklistView").setProperty("/personalizationActive",!!p);},_onPersoButtonPressed:function(){this._oTablePersoController.openDialog();},handleSelectionChange:function(E){this.resetActionButtons();var s=this._oTable.getSelectedContexts().length;if(s===0){this.oSelectedTasksDetails=null;return;}var o=E.getParameters();this.oSelectedTasksDetails=T.getSelectedTasksDetails(o,this.oSelectedTasksDetails);this.setActionButtons();},clearTaskListSelection:function(){this._oTable.removeSelections();this.resetActionButtons();this.oSelectedTasksDetails=null;},resetActionButtons:function(){},setActionButtons:function(){if(this.oSelectedTasksDetails.bIsClaimActive){var i=this.byId("claimButton");i.setVisible(true);}if(this.oSelectedTasksDetails.bIsReleaseActive){var r=this.byId("releaseButton");r.setVisible(true);}},onSortButtonPressed:function(){this._handleTableOperationsDialog("sort");},_handleTableOperationsDialog:function(o){this._oTableOperationsHelper.openTableOperationsDialog(o).attachConfirm(null,this.clearTaskListSelection.bind(this));},onClaimButtonPressed:function(E){this.performAction("Claim");},performAction:function(s){this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(true);var i=[];m.performTaskAction(s,this.oSelectedTasksDetails.oMapWithSelectedTasks,i,this.fnActionSuccess.bind(this,s,i),this.fnActionError.bind(this));},fnActionSuccess:function(s,k,o){var l=o.__batchResponses;var n=[];var E=[];var p=[];for(var i=0;i<l.length;i++){var q=l[i];var r=false;if(q.hasOwnProperty("__changeResponses")){var t=q.__changeResponses[0];if(t.statusCode>="200"&&t.statusCode<"300"){r=true;p.push({index:i,oData:t.data});}}var u=k[i];if(r){if(s==="Claim"){u.sMessage=this.getResourceBundle().getText("taskClaimedSuccesfully");}if(s==="Release"){u.sMessage=this.getResourceBundle().getText("taskReleasedSuccesfully");}n.push(u);}else if(q.response){var v=JSON.parse(q.response.body);u.sMessage=v.error.message.value;if(v.error.innererror){u.sErrorCode=v.error.innererror.errordetails[0].code;}else{u.sErrorCode=q.response.statusCode;}var w=U.fnRemoveHtmlTags(v);u.sErrorBody="<pre>"+JSON.stringify(w,null,2)+"</pre>";E.push(u);}}this.handleActionPerformed(s,n,E,p,k);},fnActionError:function(E){this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(false);this.getOwnerComponent().getErrorHandler()._showServiceError(E.message);},handleActionPerformed:function(s,i,E,k,l){if(E.length===0){if(s==="Claim"){c.show(this.getResourceBundle().getText(i.length>1?"tasksClaimed":"taskClaimed",[i.length]));}if(s==="Release"){c.show(this.getResourceBundle().getText(i.length>1?"tasksReleased":"taskReleased",[i.length]));}this.updateTableOnActionComplete(k,l);}else{this.openMessageDialog(s,i,E,k,l);}},updateTableOnActionComplete:function(i,s){m.updateTaskModelForCertainTasks(i,s);this._oTable.removeSelections(true);this.resetActionButtons();this.oSelectedTasksDetails=null;this.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(false);},openMessageDialog:function(s,i,E,k,l){if(!this.oMultiSelectMessageDialogView){this.oMultiSelectMessageDialogView=sap.ui.view({viewName:"cross.fnd.fiori.inbox.view.MultiSelectMessageDialog",type:sap.ui.core.mvc.ViewType.XML});}this.getView().addDependent(this.oMultiSelectMessageDialogView);this.oMultiSelectMessageDialogView.getController().openDialog(s,i,E,k,this.updateTableOnActionComplete.bind(this,k,l));},onReleaseButtonPressed:function(E){this.performAction("Release");},onRefreshButtonPressed:function(E){this._oPage.setBusyIndicatorDelay(0);this._oPage.setBusy(true);this.getModel("worklistView").setProperty("/refreshButtonEnabled",false);this.getModel("worklistView").setProperty("/refreshButtonPressed",true);this.clearTaskListSelection();m.refreshTaskDefinitionModel();if(this._bSystemInfoExists){m.refreshSystemInfoModel();}else{this._oIconTabBarHelper.createTabsAndFilters();this._oIconTabBarHelper.prepareRequestsforTabCounts();this._oTableOperations.setAppFilters(this._oIconTabBarHelper.getTabFilterForKey("All"));this._oTableOperations.applyTableOperations("TabCountsBatchGrp");}this._oPage.getScrollDelegate().scrollTo(0,0,0);},setTableHeaderCounter:function(i,t){var k=this.getResourceBundle().getText("worklistTableTitle");if(i<t){this.getModel("worklistView").setProperty("/worklistTableTitle",k+" ("+i+" / "+t+")");}else{this.getModel("worklistView").setProperty("/worklistTableTitle",k+" ("+t+")");}},getSapOriginsForSelectedTab:function(){var i=this.byId("idIconTabBar");var s=[];if(i.oSelectedTab){s=this.getCustomDataValues(i.oSelectedTab).aSAP__OriginList;}return s;},getCustomDataValues:function(t){var v={};if((t)&&(t.getCustomData())&&(t.getCustomData()[0])&&(t.getCustomData()[0].getValue())){v=t.getCustomData()[0].getValue();}return v;},createOriginsToDisplayNameDictionary:function(s){this.OriginsToDisplayNameDictionary={};for(var i=0;i<s.length;i++){var k=s[i].SAP__Origin;var l=s[i].DisplayName;this.OriginsToDisplayNameDictionary[k]=l;}},onDefaultActionApprove:function(E){var t=E.getSource().getCustomData()[0].getValue();var s=t.DefaultAction.DecisionKey;var i=E.getSource().getText();var k=E.getSource().getParent().getBindingContextPath();j.processCustomAction(s,i,t,k,this);},onMenuAction:function(E){var i=E.getParameter("item");var t=E.getSource().getParent().getCustomData()[0].getValue();var s=i.getKey();var k=i.getText();var l=E.getSource().getParent().getParent().getBindingContextPath();j.processCustomAction(s,k,t,l,this);},_onMasterMatched:function(){this.bReplaceHistory=!D.system.phone;if(this.oLastNavigatedItem){this.oLastNavigatedItem.setNavigated(false);}},_onRouteMatched:function(E){if(E.getParameter("name")==="myTasksMaster"||E.getParameter("name")==="myTasksDetail"||E.getParameter("name")==="myTasksDetailDetail"||E.getParameter("name")==="additionalTaskDetails"){var t=this;this.getOwnerComponent().getService("ShellUIService").then(function(s){s.setTitle(t.getResourceBundle().getText("worklistViewTitle"));},function(o){L.error("Cannot get ShellUIService",o);});}},onFiltersGoPressed:function(E){this._oFilterBarHelper.applyFilters(E);this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("tableNoDataTextAfterFiltering"));this._oPage.getScrollDelegate().scrollTo(0,0,0);},onFilterActualChange:function(){this._bActualFilterChange=true;},_initializeFilterModel:function(){this.getView().setModel(this._oFilterBarHelper.getFilterModel(),"filter");},onDPTStateChange:function(){setTimeout(function(){this.getModel("filter").setProperty("/filterTextLabelVisible",!this._oPage.getHeaderExpanded());}.bind(this));},_selectFirstFilteredTask:function(){var l=this.getOwnerComponent().getFCLHelper().getCurrentUIState().layout;if(l==="OneColumn"){return;}var t=this._oTable.getItems();if(t.length>0){t[0].firePress();}else{if(l.indexOf("TwoColumns")===-1){l="TwoColumnsMidExpanded";}this.oRouter.navTo("myTasksDetailEmpty",{layout:l},this.bReplaceHistory);}}});});
