/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","cross/fnd/fiori/inbox/model/formatter","cross/fnd/fiori/inbox/model/models","sap/ui/model/Filter","sap/ui/model/FilterOperator","cross/fnd/fiori/inbox/util/Comparators"],function(U,F,m,c,d,C){"use strict";return U.extend("cross.fnd.fiori.inbox.util.IconTabBarHelper ",{constructor:function(t,v){this._oView=v;this._oTableOperations=t;this._offlineSystems=[];this.aTabsData=[];this.numberOfNonUpdatedTabCounts=0;this.oTabsDictionary={};this.oTabFiltersList={};this.oTabCounts={};this.mIconTabBarKeytoID={};this.mSAP__OriginToIconTabID={};this.oFilterTabsIconByType={"SuccessFactors":"sap-icon://customer","Ariba":"sap-icon://cart-3","Concur":"sap-icon://flight","CPWorkflow":"sap-icon://process","Generic":"sap-icon://crm-sales","S/4HANA":"sap-icon://batch-payments","Fieldglass":"sap-icon://family-care"};this.selectedTabKey="All";this._bTaskDefinitionModelUpdated=false;this._bFilterTabsModelUpdated=false;m.attachEvent("taskDefinitionModelUpdated",null,function(){if(this._bFilterTabsModelUpdated){this.prepareTaskTypesListForAllTabs();this._bFilterTabsModelUpdated=false;}else{this._bTaskDefinitionModelUpdated=true;}},this);},getTabFilterList:function(){return this.oTabFiltersList;},getTabFilterForKey:function(k){return this.oTabFiltersList[k];},getIconTabProperty:function(t,p){var a=this.mIconTabBarKeytoID[t];return this.aTabsData[a][p];},setIconTabProperty:function(t,p,a){var b=this.mIconTabBarKeytoID[t];if(p==="count"){this.oTabCounts[t]=a;}this.aTabsData[b][p]=a;},updateOfflineSystems:function(s){var i;this._offlineSystems=[];for(i=0;i<s.length;i++){if(s[i].Status&&s[i].Status.toUpperCase()==="OFFLINE"){this._offlineSystems.push(s[i].SAP__Origin);}}m.getSystemInfoModel().setProperty("/offlineSystems",this._offlineSystems);},updateTaskTypesListForTab:function(t){m.updateTaskTypesModel(this.oTabsDictionary[t].aTabTaskTypesList);m.getTaskTypesModel().updateBindings();},prepareTaskTypesListForAllTabs:function(){for(var k in this.oTabsDictionary){this.prepareTaskTypesListForTab(k);}this.updateTaskTypesListForTab(this.selectedTabKey);},prepareTaskTypesListForTab:function(t){var T=[],o=[],a=m.getTaskDefinitionModel().getData(),s=t?this.oTabsDictionary[t].aSAP__OriginList:[];for(var b in a){if((s.indexOf(a[b].SAP__Origin)!==-1||t==="All")&&this._offlineSystems.indexOf(a[b].SAP__Origin)===-1){if(a[b].TaskName){T.push({TaskDefinitionName:a[b].TaskName,TaskDefinitionId:a[b].TaskDefinitionID});}else{o.push(a[b].TaskDefinitionID);}}}T.sort(C.fnNameComparator);if(o.length>0){T.push({TaskDefinitionName:"Others",TaskDefinitionId:"Others",TaskDefinitionIds:o});}this.oTabsDictionary[t].aTabTaskTypesList=T;},prepareTabFilters:function(){var i,j,k,f,t,a;t=this.aTabsData;this.oTabFiltersList={};this._oTableOperations.resetAppFilters();for(k=0;k<this._offlineSystems.length;k++){f=new c("SAP__Origin","NE",this._offlineSystems[k]);this._oTableOperations.addAppFilter(f,"SAP__Origin");}this._oTableOperations.createAppFilterList();this.oTabFiltersList[t[0].key]=new c(this._oTableOperations.getAppFilters(),true);this._oTableOperations.resetAppFilters();for(k=1;k<t.length;k++){a=t[k].aSAP__OriginList;var n=true;for(i=0;i<a.length;i++){var b=false;for(j=0;j<this._offlineSystems.length;j++){if(a[i]===this._offlineSystems[j]){b=true;break;}}if(b||a[i]==="EmptyOthersTab"){continue;}n=false;f=new c("SAP__Origin","EQ",a[i]);this._oTableOperations.addAppFilter(f,"SAP__Origin");}if(n){this.oTabFiltersList[t[k].key]=null;}else{this._oTableOperations.createAppFilterList();this.oTabFiltersList[t[k].key]=new c(this._oTableOperations.getAppFilters(),true);this._oTableOperations.resetAppFilters();}}},setTabCounters:function(){var t=0,T=this.aTabsData;T[0].count=this.oTabCounts[T[0].key];for(var i=1;i<T.length;i++){T[i].count=this.oTabCounts[T[i].key];t=t+this.oTabCounts[T[i].key];}if(this.selectedTabKey!=="All"&&t<T[0].count){T[0].count=t;}this._updateFilterTabsBindings();},prepareRequestforSingleTabCounts:function(k){var f=this.oTabFiltersList[k],a=[],o=this.oTabCounts[k],n;a[0]=f;if(f){m.getMainModel().read("/TaskCollection/$count",{filters:a,groupId:"TabCountsBatchGrp",success:function(D,r){n=parseInt(D,10);if(o!==n){this.oTabCounts[k]=n;this.oTabCounts["All"]=this.oTabCounts["All"]+n-o;}this.setTabCounters();}.bind(this),error:function(e){}.bind(this)});}else{this.oTabCounts[k]=0;this.oTabCounts["All"]=this.oTabCounts["All"]-o;this.setTabCounters();}},prepareRequestsforTabCounts:function(){var t=[],f=[];this.numberOfNonUpdatedTabCounts=0;for(var k in this.oTabFiltersList){t[0]=this.oTabFiltersList[k];f=[].concat(t);var s=(function(){var x=k;return function(D,r){this.oTabCounts[x]=parseInt(D,10);this.numberOfNonUpdatedTabCounts--;if(this.numberOfNonUpdatedTabCounts===0){this.setTabCounters();}};}());if(f[0]){this.numberOfNonUpdatedTabCounts++;m.getMainModel().read("/TaskCollection/$count",{filters:f,groupId:"TabCountsBatchGrp",success:s.bind(this),error:function(e){this.numberOfNonUpdatedTabCounts--;if(this.numberOfNonUpdatedTabCounts===0){this.setTabCounters();}}.bind(this)});}else{this.oTabCounts[k]=0;}}if(this.numberOfNonUpdatedTabCounts===0){this.setTabCounters();}},createTabsAndFilters:function(s){var t=this.createTabsModelData(s);this._updateFilterTabsModel(t);this.prepareTabFilters();if(this._bTaskDefinitionModelUpdated){this.prepareTaskTypesListForAllTabs();this._bTaskDefinitionModelUpdated=false;}else{this._bFilterTabsModelUpdated=true;}},_updateFilterTabsModel:function(t){var i=this._oView.byId("idIconTabBar");this._deleteSeparator();m.updateFilterTabsModel(t);this._addSeparator();if(i.oSelectedTab&&this.oTabsDictionary[this.selectedTabKey]){if(i.oSelectedTab.getProperty("key")!==this.selectedTabKey){i.setSelectedKey(this.selectedTabKey);}}else{var a=i.getItems()[0];if(a){i.oSelectedTab=a;this.selectedTabKey="All";i.setSelectedKey(this.selectedTabKey);}}},_updateFilterTabsBindings:function(){this._deleteSeparator();m.getFilterTabsModel().updateBindings();this._addSeparator();},_deleteSeparator:function(){var i=this._oView.byId("idIconTabBar");if((i.getItems().length>2)&&(i.getItems()[1]instanceof sap.m.IconTabSeparator)){i.removeItem(i.getItems()[1]);}},_addSeparator:function(){var i=this._oView.byId("idIconTabBar");if((i.getItems().length>2)&&!(i.getItems()[1]instanceof sap.m.IconTabSeparator)){var s=new sap.m.IconTabSeparator();i.insertItem(s,1);}},createTabsModelData:function(s){var t=[],A={count:this.oTabCounts["All"],icon:"",key:"All",showAll:true,text:this._oView.getController().getResourceBundle().getText("allIconTabTitle"),visible:true,aSAP__OriginList:[],aSystemTypeList:[]};this.aTabsData=t;this.oTabsDictionary={};t.push(A);this.oTabsDictionary["All"]={aSAP__OriginList:[],aSystemTypeList:[]};if(!s){s=[];return t;}this.updateOfflineSystems(s);var i,o;for(i=0;i<s.length;i++){var g=s[i].Group;if(jQuery.type(g)!=="string"){g="Others";}else if(g.length===0||g.toUpperCase()==="OTHERS"){g="Others";}else if(g.toUpperCase()==="ALL"){continue;}if(!this.oTabsDictionary.hasOwnProperty(g)){this.oTabsDictionary[g]={};this.oTabsDictionary[g].aSystemTypeList=[s[i].SystemType];this.oTabsDictionary[g].aSAP__OriginList=[s[i].SAP__Origin];}else{if(this.oTabsDictionary[g].aSystemTypeList.indexOf(s[i].SystemType)===-1){this.oTabsDictionary[g].aSystemTypeList.push(s[i].SystemType);}if(this.oTabsDictionary[g].aSAP__OriginList.indexOf(s[i].SAP__Origin)===-1){this.oTabsDictionary[g].aSAP__OriginList.push(s[i].SAP__Origin);}}}var T=[];var e;T=Object.keys(this.oTabsDictionary).sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase());});for(i=0;i<T.length;i++){e=T[i];if(e==="Others"){o={count:this.oTabCounts["Others"],icon:this.oFilterTabsIconByType.Generic,key:"Others",text:this._oView.getController().getResourceBundle().getText("tabOthersTitle"),visible:true,aSAP__OriginList:this.oTabsDictionary[e].aSAP__OriginList,aSystemTypeList:this.oTabsDictionary[e].aSystemTypeList};}else if(e.toUpperCase()!=="ALL"){var I=this.oFilterTabsIconByType.Generic;if(this.oTabsDictionary[e].aSystemTypeList.length===1){I=this.oFilterTabsIconByType[this.oTabsDictionary[e].aSystemTypeList[0]];}if(!I){I=this.oFilterTabsIconByType.Generic;}t.push({count:this.oTabCounts[e],icon:I,key:e,text:e,visible:true,aSAP__OriginList:this.oTabsDictionary[e].aSAP__OriginList,aSystemTypeList:this.oTabsDictionary[e].aSystemTypeList});}}if(t.length>1){if(!o){o={count:this.oTabCounts["Others"],icon:this.oFilterTabsIconByType.Generic,key:"Others",text:this._oView.getController().getResourceBundle().getText("tabOthersTitle"),visible:true,aSAP__OriginList:["EmptyOthersTab"],aSystemTypeList:[]};this.oTabsDictionary["Others"]={aSAP__OriginList:[],aSystemTypeList:[]};}t.push(o);}var j,S;this.mSAP__OriginToIconTabID={};this.mIconTabBarKeytoID={};for(i=0;i<t.length;i++){this.mIconTabBarKeytoID[t[i].key]=i;S=t[i].aSAP__OriginList;for(j=0;j<S.length;j++){this.mSAP__OriginToIconTabID[S[j]]=t[i].key;}}return t;}});});
