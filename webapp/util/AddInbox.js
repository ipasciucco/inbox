/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","sap/ui/core/mvc/XMLView","sap/ui/model/json/JSONModel","cross/fnd/fiori/inbox/util/Substitution","cross/fnd/fiori/inbox/util/tools/Application"],function(U,B,X,J,S,A){"use strict";var _=null;var a=null;var b=null;var c="TAKE_OVER";var d=null;U.extend("cross.fnd.fiori.inbox.util.AddInbox",{});cross.fnd.fiori.inbox.util.AddInbox={open:function(){if(!_){this._createAddInboxDialogPromise().then(function(x){_=x;a=_.byId("DLG_ADD_INBOX");b=_.byId("LST_USERS");d=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getDataManager();this._setUpAndOpenDialog.call(this);}.bind(this));}else{this._setUpAndOpenDialog.call(this);}},_setAgents:function(e){a.getModel().setProperty("/agents",e);a.rerender();},refreshDataAfterUpdateSubstitutionRule:function(){b.setBusyIndicatorDelay(1000);b.setBusy(true);d.readAddInboxUsers(jQuery.proxy(this._addInboxUsersReadSuccess,this),function(){b.setBusy(false);a.close();});},_addInboxUsersReadSuccess:function(r){var D=[];var n;var t=this;b.setBusy(false);jQuery.each(r.results,function(i,o){if(o.Mode===c&&!S.isRuleOutdated(o.EndDate)){n=true;o.User=o.User.toUpperCase();jQuery.each(D,function(e,p){if(p.User===o.User){t._mergeRule(p,o);n=false;return false;}});if(n){D.push(t._getProcessedRuleObject(o));}}});if(D.length>0){this._setStatus(D);this._setAgents(D);}else{b.setShowNoData(true);b.rerender();}},_mergeRule:function(m,C){if(!m.IsEnabled&&C.IsEnabled){m.IsEnabled=true;}var k=C.IsEnabled?m.aEnabledRules:m.aDisabledRules;k.push({subRuleId:C.SubstitutionRuleID,sOrigin:C.SAP__Origin});},_getProcessedRuleObject:function(r){var n={User:r.User,FullName:r.FullName,SupportsEnableSubstitutionRule:r.SupportsEnableSubstitutionRule,IsEnabled:r.IsEnabled,SAP__Origin:r.SAP__Origin,aEnabledRules:[],aDisabledRules:[]};var k=r.IsEnabled?n.aEnabledRules:n.aDisabledRules;k.push({subRuleId:r.SubstitutionRuleID,sOrigin:r.SAP__Origin});return n;},_setStatus:function(D){jQuery.each(D,function(i,r){r.bShowWarning=(r.aEnabledRules.length>0&&r.aDisabledRules.length>0)?true:false;});},_setUpAndOpenDialog:function(){var m=new J();a.setModel(m);b.setShowNoData(false);b.removeSelections(true);a.open();this.refreshDataAfterUpdateSubstitutionRule();},_createAddInboxDialogPromise:function(){return X.create({id:"MIB_VIEW_ADD_INBOX",viewName:"cross.fnd.fiori.inbox.view.AddInbox"}).catch(function(){B.error("Add Inbox dialog was not created successfully");});}};return cross.fnd.fiori.inbox.util.AddInbox;});
