/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Column","sap/m/Label","sap/ui/model/json/JSONModel","cross/fnd/fiori/inbox/controller/BaseController","sap/ui/base/DataType","cross/fnd/fiori/inbox/util/MultiSelect","cross/fnd/fiori/inbox/util/MultiSelectCustomAttributeHelper","cross/fnd/fiori/inbox/util/TableOperations","cross/fnd/fiori/inbox/util/MultiSelectSortingHelper","sap/ui/core/syncStyleClass","sap/m/TablePersoController"],function(C,L,J,B,D,M,a,T,b,s,c){"use strict";return B.extend("cross.fnd.fiori.inbox.view.MultiSelectSummary",{_oTablePersoController:null,onInit:function(){cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().subscribe("cross.fnd.fiori.inbox","multiselect",this.onMultiSelectEvent,this);var o=this.getOwnerComponent();o.getEventBus().subscribe("cross.fnd.fiori.inbox","multiselect",this.onMultiSelectEvent,this);this.oRouter=o.getRouter();this.oRouter.attachRouteMatched(this.handleNavToDetail,this);this.bInited=false;this._oTableOperations=new T(this.getMultiSelectTable(),this.getView(),["TaskTitle","Priority","DueOn"]);this._oSorting=new b(this._oTableOperations,this.getView());this._tableHelper=new a(this,this.getView(),this.getMultiSelectTable(),this._oSorting);},onMultiSelectEvent:function(d,e,m){var i;if(m.Source==="S2"||m.Source==="action"){if(m.reInitialize){this.aWorkItems=m.WorkItems;}if(m.WorkItems.length>0){for(i=0;i<m.WorkItems.length;i++){if(m.Selected){m.WorkItems[i].Selected=m.Selected;this.addWorkItem(m.WorkItems[i]);}else{this.removeWorkItem(m.WorkItems[i]);}}}else{this.aWorkItems=[];}this.refreshModel();this._oSorting.applySorting();}if(m.Source==="MultiSelectSummary"&&!m.Selected&&m.WorkItems.length>0){for(i=0;i<m.WorkItems.length;i++){this.removeWorkItem(m.WorkItems[i]);}this.refreshModel();this._oSorting.applySorting();}},removeWorkItem:function(w){this.aWorkItems=this.aWorkItems.filter(function(W){return!(w.SAP__Origin===W.SAP__Origin&&w.InstanceID===W.InstanceID);});},addWorkItem:function(w){var i;for(i=0;i<this.aWorkItems.length;i++){if(this.aWorkItems[i].SAP__Origin===w.SAP__Origin&&this.aWorkItems[i].InstanceID===w.InstanceID){return;}}var W=jQuery.extend(true,{},w);if(this.areCustomDefinitionsPresent()){var l=w.listItem;var d=l.getBindingContext();var e=jQuery.extend(true,[],d.getProperty("CustomAttributeData"));for(i=0;i<e.length;i++){var p="/"+e[i];var f=l.getModel().getProperty(p);W[f.Name]=f.Value;}}this.aWorkItems.push(W);},refreshModel:function(){M.prepareWorkItems(this.aWorkItems);var m=new J(this.aWorkItems);this.getMultiSelectTable().setModel(m,"multiSelectSummaryModel");},handleNavToDetail:function(e){if(e.getParameter("name")!=="multi_select_summary"){return;}this._oSorting.resetSorting();this._tableHelper.hideCustomAttributeColumns();this.aWorkItems=[];this.refreshModel();if(this.areCustomDefinitionsPresent()){jQuery.when(M.customAttributeDefinitionsLoaded).then(function(){M.customAttributeDefinitionsLoaded=new jQuery.Deferred();this.initTableHeader();this._initPersonalization();}.bind(this));}else{this._initPersonalization();}if(!this.bInited){this.bInited=true;this.getMultiSelectTable().bindItems("multiSelectSummaryModel>/",this.getView().byId("LIST_ITEM"));}},onItemSelect:function(e){var m={};m.Source="MultiSelectSummary";m.Selected=e.getParameter("selected");var l=e.getParameter("listItems");var w=[];for(var i=0;i<l.length;i++){w[i]=l[i].getBindingContext("multiSelectSummaryModel").getProperty();}m.WorkItems=w;cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().publish("cross.fnd.fiori.inbox","multiselect",m);},onSortPressed:function(){this._oSorting.openSortingDialog();},attachControl:function(o){var d=this.getOwnerComponent().getContentDensityClass();s(d,this.getView(),o);this.getView().addDependent(o);},initTableHeader:function(){this.customAttributeDefinitions=this.getOwnerComponent().getModel("customAttributeDefinitionsModel").getData().results;for(var i=0;i<this.customAttributeDefinitions.length;i++){if(this.customAttributeDefinitions[i]){this._tableHelper.addColumn(this.customAttributeDefinitions[i]);}}var m=this.getMultiSelectTable();m.bindItems(m.getBindingInfo("items"));m.getBinding("items").refresh();},areCustomDefinitionsPresent:function(){var d=this.getOwnerComponent().getModel("customAttributeDefinitionsModel");if(d===null){return false;}return typeof d==="object";},getMultiSelectTable:function(){return this.byId("idMultiSelectTable");},_initPersonalization:function(){if(sap.ushell.Container){if(this._oTablePersoController!==null){this._oTablePersoController.destroy();this._oTablePersoController=null;}var t=this.oView.byId("idMultiSelectTable");var p=sap.ushell.Container.getService("Personalization");var P=p.getPersonalizer({container:"cross.fnd.fiori.inbox.multiSelect.table",item:"idMultiSelectTable"});this._oTablePersoController=new sap.m.TablePersoController({table:t,componentName:"idMultiSelectTable",showResetAll:false,persoService:P}).activate();}},onPersonalizationPressed:function(){this._oTablePersoController.openDialog();}});});
