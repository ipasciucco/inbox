/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/Device","sap/ui/base/EventProvider","sap/ui/model/Filter","sap/base/Log","cross/fnd/fiori/inbox/model/ModelsHelper","cross/fnd/fiori/inbox/model/PagingHelper","cross/fnd/fiori/inbox/util/Comparators","cross/fnd/fiori/inbox/util/Constants"],function(J,D,E,F,L,M,P,C,a){"use strict";var m={mainModel:null,deviceModel:null,taskModel:null,taskDefinitionModel:null,responseOptionsModel:null,systemInfoModel:null,filterTabsModel:null,taskTypesModel:null,taskDetailModel:null,workflowLogModel:null};var p={};var b={};var c=E.extend("cross.fnd.fiori.inbox.model.models",{sBatchGroupName:"batchCreate",sDecisionOptionsBatch:"DecisionOptionsBatch",sDetailsBatch:"DetailsBatch",sTabCountsBatch:"TabCountsBatchGrp",sCustomAttrColumnBatch:"CustomAttrColumnGrp",bResponseOptionsExist:false,setMainModel:function(d){m.mainModel=d;this.setMainModelDeferredGroupsForBatch();},getMainModel:function(){return m.mainModel;},getDeviceModel:function(){if(!m.deviceModel){m.deviceModel=new J(D);m.deviceModel.setDefaultBindingMode("TwoWay");}return m.deviceModel;},resetDeviceModel:function(){m.deviceModel=null;},getTaskModel:function(){if(!m.taskModel){m.taskModel=new J();m.taskModel.setDefaultBindingMode("TwoWay");}return m.taskModel;},resetTaskModel:function(){m.taskModel=null;},updateTaskModel:function(d){this.getTaskModel().setData(d);},refreshTaskModel:function(u,s,f,B){p=new P(u,s,f);m.mainModel.read("/TaskCollection",{urlParameters:p.getURLParameters(),sorters:p.getSorters(),filters:p.getFilters(),groupId:B,success:function(d,r){var l=d.results[d.results.length-1];p.setLastItem(l);d.results=this._dataMassage(d.results);if(this.bResponseOptionsExist){this.updateTaskModelWithResponseOptions(d.results);}this.updateTaskModel(d);this.fireEvent("taskModelUpdated");}.bind(this),error:function(e){this.fireEvent("taskModelUpdateError");}.bind(this)});},loadNextPageInTaskModel:function(){L.debug("Model size begin: "+this.getTaskModel().getData().results.length,"models.js","MyTasks");if(p.getLastPageLoaded()){this.getTaskModel().updateBindings();return;}m.mainModel.read("/TaskCollection",{urlParameters:p.getURLParameters(),sorters:p.getSorters(),filters:p.getFilters(),success:function(d,r){if(d.results.length===0){this.getTaskModel().updateBindings();p.setLastPageLoaded(true);L.debug("Model size end: "+this.getTaskModel().getData().results.length,"models.js","MyTasks");return;}if(d.results.length<p.getPageSize()){p.setLastPageLoaded(true);}var l=d.results[d.results.length-1];var e=p.getLastItem();if(e.InstanceID===l.InstanceID){return;}p.setLastItem(l);var f=this.getTaskModel().getData();if(this.bResponseOptionsExist){this.updateTaskModelWithResponseOptions(d.results);}f.results=f.results.concat(d.results);this.getTaskModel().updateBindings();L.debug("Model size end: "+this.getTaskModel().getData().results.length,"models.js","MyTasks");return;}.bind(this),error:function(e){this.fireEvent("taskModelUpdateError");}.bind(this)});},_dataMassage:function(t){var T;for(var i=0;i<t.length;i++){T=t[i];if(T.CustomAttributeData&&T.CustomAttributeData.results){for(var j=0;j<T.CustomAttributeData.results.length;j++){T[encodeURIComponent("CA_"+T.CustomAttributeData.results[j].Name)]=T.CustomAttributeData.results[j].Value;}t[i]=T;}}return t;},setMainModelDeferredGroupsForBatch:function(){var d=m.mainModel.getDeferredGroups();d.push(this.sBatchGroupName);d.push(this.sDecisionOptionsBatch);d.push(this.sDetailsBatch);d.push(this.sTabCountsBatch);d.push(this.sCustomAttrColumnBatch);m.mainModel.setDeferredGroups(d);},performTaskAction:function(s,o,S,A,f){if(m.mainModel.hasPendingChanges()){m.mainModel.resetChanges();}var n=0;var d;for(var k in o){if(o.hasOwnProperty(k)){var v=o[k];d="changeSetId"+n;m.mainModel.createEntry("/"+s,{changeSetId:d,groupId:this.sBatchGroupName,urlParameters:{SAP__Origin:"'"+v.SAP__Origin+"'",InstanceID:"'"+v.InstanceID+"'"}});S.push(v);n++;}}m.mainModel.submitChanges({groupId:this.sBatchGroupName,success:A,error:f});},updateTaskModelForCertainTasks:function(d,s){if(d&&d.length>0){var t=this.getTaskModel();var o;for(var i=0;i<d.length;i++){o=d[i];var e=t.getProperty(s[o.index].sContextPath);for(var f in e){if(e.hasOwnProperty(f)&&o.oData.hasOwnProperty(f)){e[f]=o.oData[f];}}t.setProperty(s[o.index].sContextPath,e);}}},getTaskDefinitionModel:function(){if(!m.taskDefinitionModel){m.taskDefinitionModel=new J();m.taskDefinitionModel.setDefaultBindingMode("TwoWay");}return m.taskDefinitionModel;},resetTaskDefinitionModel:function(){m.taskDefinitionModel=null;this.resetResponseOptionsModel();},updateTaskDefinitionModel:function(t,d){var i;if(d){for(i=0;i<t.length;i++){if((t[i].CustomAttributeDefinitionData)&&(t[i].CustomAttributeDefinitionData.results)){var e=M.convertArrayToMap(t[i].CustomAttributeDefinitionData.results,M.getKeyForCustomAttributeDefinitionModel);M.addPrefixToCustomAttributes(e);t[i].CustomAttributeDefinitionData=e;}}}var f={};if(this.bResponseOptionsExist){for(i=0;i<t.length;i++){var r=t[i][a.NP_RESPONSE_OPTIONS_DATA];if((r)&&(r.results)){M.processResponseOptions(r.results,f);r=r.results;r.sort(C.fnResponseOptionsComparator);t[i][a.NP_RESPONSE_OPTIONS_DATA]=r;}}}var g=M.convertArrayToMap(t,M.getKeyForTaskDefinitionModel);this.getTaskDefinitionModel().setData(g);this.updateResponseOptionsModel(f);},refreshTaskDefinitionModel:function(){var s=["SAP__Origin","TaskDefinitionID","TaskName"];var e=[];var d=[];var f=false;if(this.checkPropertyExistsInMetadata("CustomAttributeDefinitionCollection",null)||this.checkPropertyExistsInMetadata("CustomAttributeDefinition",null)){f=true;e.push("CustomAttributeDefinitionData");s.push("CustomAttributeDefinitionData");}if(this.checkPropertyExistsInMetadata(a.ES_RESPONSE_OPTIONS_COLLECTION,null)){this.bResponseOptionsExist=true;s.push(a.NP_RESPONSE_OPTIONS_DATA);if(this.checkPropertyExistsInMetadata(a.ES_REASON_DEFINITIONS_COLLECTION,null)){e.push(a.NP_RESPONSE_OPTIONS_DATA+"/"+a.NP_REASON_DEFINITIONS_DATA);}else{e.push(a.NP_RESPONSE_OPTIONS_DATA);}}d.push("$select="+s.join());if(e.length>0){d.push("$expand="+e.join());}m.mainModel.read("/TaskDefinitionCollection",{urlParameters:d,success:function(o){this.updateTaskDefinitionModel(o.results,f);this.fireEvent("taskDefinitionModelUpdated");}.bind(this)});},getResponseOptionsModel:function(){if(!m.responseOptionsModel){m.responseOptionsModel=new J();m.responseOptionsModel.setDefaultBindingMode("TwoWay");}return m.responseOptionsModel;},updateResponseOptionsModel:function(d){this.getResponseOptionsModel().setData(d);},resetResponseOptionsModel:function(){m.responseOptionsModel=null;},getSystemInfoModel:function(){if(!m.systemInfoModel){m.systemInfoModel=new J();}return m.systemInfoModel;},resetSystemInfoModel:function(){m.systemInfoModel=null;},updateSystemInfoModel:function(d){this.getSystemInfoModel().setData(d);},refreshSystemInfoModel:function(){m.mainModel.read("/SystemInfoCollection",{success:function(d,r){this.updateSystemInfoModel(d);this.fireEvent("systemInfoModelUpdated");}.bind(this),error:function(e){this.fireEvent("systemInfoModelUpdateError");}.bind(this)});},checkPropertyExistsInMetadata:function(e,s){var S=m.mainModel.getMetaModel();return M.checkPropertyExistsInMetadata(e,s,S);},getFilterTabsModel:function(){if(!m.filterTabsModel){m.filterTabsModel=new J();}return m.filterTabsModel;},updateFilterTabsModel:function(d){this.getFilterTabsModel().setData(d);},resetFilterTabsModel:function(){m.filterTabsModel=null;},getTaskTypesModel:function(){if(!m.taskTypesModel){m.taskTypesModel=new J();m.taskTypesModel.setDefaultBindingMode("TwoWay");}return m.taskTypesModel;},updateTaskTypesModel:function(d){this.getTaskTypesModel().setData(d);},resetTaskTypesModel:function(){m.taskTypesModel=null;},updateTaskModelWithCustomActions:function(){if(m.mainModel.hasPendingChanges()){m.mainModel.resetChanges();}var s=function(o){var B=o.__batchResponses;var f;var r;for(var j in B){f=B[j];if(f.hasOwnProperty("data")&&f.statusCode>="200"&&f.statusCode<"300"){r=f.data.results;if(r){M.addDisplayOrderPriorityIfMissing(r);r.sort(C.fnResponseOptionsComparator);m.taskModel.getData().results[j].DefaultAction=r.shift();m.taskModel.getData().results[j].DecisionOptions=r;}}}m.taskModel.updateBindings();this.fireEvent("customActionsUpdated");}.bind(this);var e=function(o){this.fireEvent("customActionsUpdateError");}.bind(this);var t=m.taskModel.getData().results;for(var i=0;i<t.length;i++){var T=t[i];var d="ChangeSetId"+i;var u={SAP__Origin:T.SAP__Origin,InstanceID:T.InstanceID};m.mainModel.callFunction("/DecisionOptions",{urlParameters:u,groupId:this.sDecisionOptionsBatch,changeSetId:d});}m.mainModel.submitChanges({groupId:this.sDecisionOptionsBatch,success:s,error:e});},updateTaskModelWithResponseOptions:function(t){var r,T=this.getTaskDefinitionModel().getData(),d;if(T&&t){for(var i=0;i<t.length;i++){d=T[M.getKeyForTaskDefinitionModel(t[i])];if(d){r=[].concat(d[a.NP_RESPONSE_OPTIONS_DATA]);t[i].DefaultAction=r.shift();t[i][a.RESPONSE_OPTIONS]=r;}}}},callCustomAction:function(d,s,e,n,r){var u={SAP__Origin:d.SAP__Origin,InstanceID:d.InstanceID,DecisionKey:d.DecisionKey};if(n){u.Comments=n;}if(r){u.ReasonCode=r;}m.mainModel.callFunction("/"+a.FI_DECISION,{method:"POST",urlParameters:u,success:s,error:e});},getTaskDetailModel:function(){if(!m.taskDetailModel){m.taskDetailModel=new J();}return m.taskDetailModel;},updateTaskDetailModel:function(d,e){this.getTaskDetailModel().setData(d,e);},resetTaskDetailModel:function(){m.taskDetailModel=null;},refreshTaskDetailModel:function(S,I,d,e){if(m.mainModel.hasPendingChanges()){m.mainModel.resetChanges();}var t=this.getTaskDetailModel().getData();var s="ChangeSetIdDetails";m.mainModel.read("/TaskCollection(SAP__Origin='"+encodeURIComponent(S)+"',InstanceID='"+encodeURIComponent(I)+"')",{urlParameters:d,groupId:this.sDetailsBatch,changeSetId:s});var f=function(h,o){var i=this.getTaskDetailModel().getData();if(h!==i.taskSwitchCount){return;}if(o.__batchResponses&&o.__batchResponses[0]){var B=o.__batchResponses[0];if(B.statusCode>="200"&&B.statusCode<"300"){var n=B.data;var j=this.getTaskDefinitionModel().getData();var T=M.updateCustAttrDataWithCustAttrDefsAndSetVisibility(n,i,j,e);T=M.setVisibilityFlagsInDetail(T);this.updateTaskDetailModel(T,true);this.fireEvent("taskDetailRequestSuccess");}}}.bind(this,t.taskSwitchCount);var g=function(h,o){var i=this.getTaskDetailModel().getData();if(h!==i.taskSwitchCount){return;}this.fireEvent("taskDetailRequessError");}.bind(this,t.taskSwitchCount);m.mainModel.submitChanges({groupId:this.sDetailsBatch,success:f,error:g});},getWorkflowLogModel:function(){if(!m.workflowLogModel){m.workflowLogModel=new J();}return m.workflowLogModel;},updateWorkflowLogModel:function(d){this.getWorkflowLogModel().setData(d);},refreshWorkflowLogModel:function(I,S){var s="/TaskCollection"+"(InstanceID='"+I+"',"+"SAP__Origin='"+S+"')"+"/WorkflowLogs";m.mainModel.read(s,{success:function(d,r){this.updateWorkflowLogModel(d);this.getWorkflowLogModel().setProperty("/modelUpdated",true);this.fireEvent("workflowLogModelUpdated");}.bind(this),error:function(e){this.fireEvent("workflowLogModelUpdateError");}.bind(this)});},resetWorkflowLogModel:function(){m.workflowLogModel=null;}});b=new c();return b;});
