/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["cross/fnd/fiori/inbox/util/ConfirmationDialogManager","cross/fnd/fiori/inbox/util/EmployeeCard","sap/ca/ui/utils/resourcebundle","sap/ui/Device"],function(C,E,r,D){"use strict";sap.ui.controller("cross.fnd.fiori.inbox.view.Forward",{_FORWARD_DIALOG_ID:"DLG_FORWARD",_SEARCH_FIELD_ID:"SFD_FORWARD",_FORWARDER_LIST_ID:"LST_AGENTS",_FORWARDER_ITEM_ID:"ITM_AGENT",iMaxAgent:100,extHookChangeListSizeLimit:null,oConfirmationDialogManager:C,onInit:function(){this.getView().setModel(cross.fnd.fiori.inbox.util.tools.Application.getImpl().AppI18nModel,"i18n");var a=this.getView().byId(this._FORWARDER_LIST_ID);a.bindProperty("showNoData",{path:"/agents",formatter:function(A){return(A===undefined)?false:true;}});var e=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus();e.subscribe("cross.fnd.fiori.inbox.dataManager","showLoaderInDialogs",this.onShowLoaderInDialogs.bind(this));if(D.system.phone){var d=this.getView().byId(this._FORWARD_DIALOG_ID);d.setStretch(true);}},onShowLoaderInDialogs:function(c,e,v){var f=this.getView().byId(this._FORWARD_DIALOG_ID);if(f){f.setBusyIndicatorDelay(1000).setBusy(v.bValue);}},onCancelDialog:function(){var f=this.getView().byId(this._FORWARD_DIALOG_ID);f.close();},onBeforeOpenDialog:function(){var f=this.getView().byId(this._SEARCH_FIELD_ID);var F=this.getView().byId(this._FORWARD_DIALOG_ID);F.setInitialFocus(f);f.setValue("");this.fnStartSearch=undefined;this.fnCloseDlg=undefined;var d=F.getModel();if(d){this.fnStartSearch=d.getProperty("/startSearch");this.fnCloseDlg=d.getProperty("/closeDlg");}if(this.extHookChangeListSizeLimit){var s=this.extHookChangeListSizeLimit();d.setSizeLimit(s);this.iMaxAgent=s;}},onLiveChange:function(e){if(this.getView().byId(this._FORWARD_DIALOG_ID).getModel().getProperty("/isPreloadedAgents")){var s=e.getParameters().newValue;var l=this.getView().byId("LST_AGENTS").getItems();for(var i=0;i<l.length;i++){var v=this.fnStartSearch(l[i],s);l[i].setVisible(v);}this.getView().byId("LST_AGENTS").rerender();}},onAgentSearch:function(e){if(!this.getView().byId(this._FORWARD_DIALOG_ID).getModel().getProperty("/isPreloadedAgents")){var s=e.getParameters().query;var d=this.getView().byId("DLG_FORWARD");if(s.length!==0){this.bSearchUsers=true;var c=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent();var o=c.getDataManager();var O=this.getView().byId(this._FORWARD_DIALOG_ID).getModel().getProperty("/origin");o.searchUsers(O,s,this.iMaxAgent,function(R){d.getModel().setProperty("/agents",[]);d.getModel().setProperty("/agents",R);this.getView().byId("LST_AGENTS").rerender();}.bind(this));}else{d.getModel().setProperty("/agents",[]);this.getView().byId("LST_AGENTS").rerender();}var n=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().oDataManager.oi18nResourceBundle.getText("view.Forward.noRecipientsAfterSearch");this.getView().byId("LST_AGENTS").setNoDataText(n);}},_findListItemById:function(I){var l=this.getView().byId("LST_AGENTS").getItems();for(var i=0;i<l.length;i++){if(l[i].getId()===I){return l[i];}}},onSelectAgent:function(e){var s=this._findListItemById(e.getParameters().id);if(s&&s.getBindingContext()){this.getView().byId(this._FORWARD_DIALOG_ID).close();var S=s.getBindingContext().getObject();var d=this.getView().byId(this._FORWARD_DIALOG_ID).getModel();var n=d.getProperty("/numberOfItems");var q="";if(n===undefined){q=r.getText("forward.question",S.DisplayName);}else if(n===1){q=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().oDataManager.oi18nResourceBundle.getText("XMSG_MULTI_FORWARD_QUESTION",S.DisplayName);}else{q=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().oDataManager.oi18nResourceBundle.getText("XMSG_MULTI_FORWARD_QUESTION_PLURAL",[n,S.DisplayName]);}this.oConfirmationDialogManager.showDecisionDialog({question:q,textAreaLabel:cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().oDataManager.oi18nResourceBundle.getText("XFLD_TextArea_Forward"),showNote:true,noteMandatory:false,title:r.getText("forward.title"),confirmButtonLabel:r.getText("forward.button"),confirmActionHandler:function(N){this.forwardConfirmClose(N,S);}.bind(this)});}},forwardConfirmClose:function(n,s){var N={};N={bConfirmed:true,sNote:n,oAgentToBeForwarded:s};this.fnCloseDlg(N);},handleDetailPress:function(e){var s=this._findListItemById(e.getParameters().id);var p=s.getBindingContext().getPath();var a=p.substring(8,p.length);var b=this.getView().byId(this._FORWARD_DIALOG_ID).getModel().getData().agents[a];if(D.system.tablet&&D.orientation.portrait){E.displayEmployeeCard(e.getSource()._detailIcon,b);}else{E.displayEmployeeCard(e.getSource(),b);}}});});
