/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/base/security/URLWhitelist","sap/base/Log","sap/base/security/encodeURLParameters","sap/ui/base/Object","sap/ui/thirdparty/jquery","sap/m/MessageBox","sap/m/MessageToast","cross/fnd/fiori/inbox/util/Parser"],function(U,L,e,a,q,M,b,P){"use strict";return a.extend("cross.fnd.fiori.inbox.util.ActionHelper",{GUILinkProperty:"GUI_Link",_oURLParsingService:null,constructor:function(c,v){this._oView=v;this._oController=c;this._oResourceBundle=c.getResourceBundle();},isIntentURL:function(u){this._oURLParsingService=this._oURLParsingService||sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService&&sap.ushell.Container.getService("URLParsing");return this._oURLParsingService&&this._oURLParsingService.isIntentUrl(u);},isAnnotationBasedTask:function(u){var p=P.fnParseComponentParameters(u);return!q.isEmptyObject(p);},getURLParsingService:function(){return this._oURLParsingService;},fnValidateOpenTaskURLAndRedirect:function(u,p){if(sap.ushell.Container){var c=sap.ushell.Container.getService("URLParsing");if(c){if(c.isIntentUrl(u)){var o=c.parseShellHash(u);o.params["sap-ushell-navmode"]=["explace"];o.target={semanticObject:o.semanticObject,action:o.action};var C=sap.ushell.Container.getService("CrossApplicationNavigation");C.isNavigationSupported([o]).done(function(r){if(r[0].supported===true){C.toExternal(o);}else{L.error("Intent is not supported for sURL: "+u,"cross.fnd.fiori.inbox.util.ActionHelper");}}).fail(function(E){L.error("isNavigationSupported failed processing sURL: "+u,E,"cross.fnd.fiori.inbox.util.ActionHelper");});}else if(U.validate(u)){sap.m.URLHelper.redirect(this.addOrReplaceParameters(u,p?this._getSapURLParameters():{}),true);}else if(U.validate(encodeURI(u))){u=encodeURI(u);sap.m.URLHelper.redirect(this.prependParameters(u,p?this._getSapURLParameters():{}),true);}else{M.error(this._oResourceBundle.getText("dialog.error.taskExecutionUI"));}}else{L.error("URL Parsing service look up failed as a result Open Task action will not work.");}}else{L.error("ushell container does not exist as a result Open Task action will not work.");}},addOrReplaceParameters:function(u,c){var d=sap.ushell.Container.getService("URLParsing");var h=d.getHash(u);var r=u;if(h){r=u.substring(0,u.indexOf(h)-1);}var p;if(r.indexOf("?")!==-1){p=r.substring(r.indexOf("?"));r=r.substring(0,r.indexOf("?"));}var f=d.parseParameters(p);for(var g in c){f[g]=c[g];}p=d.paramsToString(f);var i=r+"?"+p;if(h){i+="#"+h;}return i;},prependParameters:function(u,c){var d=sap.ushell.Container.getService("URLParsing");var h=d.getHash(u);var r=u;if(h){r=u.substring(0,u.indexOf(h)-1);}var p;if(r.indexOf("?")!==-1){p=r.substring(r.indexOf("?")+1);r=r.substring(0,r.indexOf("?"));}var f=d.paramsToString(c);p=(p)?p=f+"&"+p:p=f;var g=r+"?"+p;if(h){g+="#"+h;}return g;},isOpenTaskEnabled:function(i,E){if(!i.TaskSupports.UIExecutionLink){return false;}else if((i.GUI_Link||(i.UIExecutionLink&&i.UIExecutionLink.GUI_Link))&&(this.isAnnotationBasedTask(i.GUI_Link?i.GUI_Link:i.UIExecutionLink.GUI_Link))){return false;}else if(i.TaskSupports.UIExecutionLink&&!i.GUI_Link&&i.UIExecutionLink&&!i.UIExecutionLink.GUI_Link){return false;}else if(E){return false;}else{return true;}},_getSapURLParameters:function(){var p=this._getThemeandLanguageLocaleParams();q.extend(p,this._getUI5LegacyFormatParams());q.extend(p,this._getSapAccessibilityParam());q.extend(p,this._getSapStatisticsParam());return p;},_getUI5LegacyFormatParams:function(){var o={};var l=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyDateFormat();var s=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyTimeFormat();var c=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyNumberFormat();if(l){o["sap-ui-legacy-date-format"]=l;}if(s){o["sap-ui-legacy-time-format"]=s;}if(c){o["sap-ui-legacy-number-format"]=c;}return o;},_getSapAccessibilityParam:function(){var A={};var s=sap.ushell.Container.getUser().getAccessibilityMode();if(s){A["sap-accessibility"]="X";}return A;},_getSapStatisticsParam:function(){var s={};var S=sap.ui.getCore().getConfiguration().getStatistics();if(S){s["sap-statistics"]=S;}return s;},_getThemeandLanguageLocaleParams:function(){var A=sap.ui.getCore().getConfiguration().getTheme();var l=sap.ui.getCore().getConfiguration().getSAPLogonLanguage()||"";var s=sap.ui.getCore().getConfiguration().getLocale();var t=sap.ushell.Container?sap.ushell.Container.getUser().getTheme(sap.ushell.User.prototype.constants.themeFormat.NWBC):null;var p={};var r=/^sap_hcb/i;var T={sap_hcb:{WDJ:"/com.sap.ui.lightspeed/themes/sap_hcb",WDA:"sap_hcb"}};if(A){if(r.test(A)){p["sap-ui-theme"]=A;p["sap-theme-name"]=A;var o=T[A];if(o){if(o["WDJ"]){p["sap-cssurl"]=location.protocol+"//"+location.host+":"+location.port+o["WDJ"];}if(o["WDA"]){p["sap-theme"]=o["WDA"];}}}else{p["sap-ui-theme"]=A;p["sap-theme-name"]=A;}}if(l){p["sap-language"]=l;}if(s){p["sap-locale"]=s;}if(t){p["sap-theme-NWBC"]=t;}return p;},openTaskInNewWindow:function(u){if(u&&u.GUI_Link&&u.GUI_Link!==""){var s=u.GUI_Link;var d=cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getDataManager();this.fnValidateOpenTaskURLAndRedirect(s,d.isForwardUserSettings());}else{this.showErrorOnOpenTask();}},showErrorOnOpenTask:function(){b.show(this.i18nBundle.getText("dialog.error.taskExecutionUI"));},getSelectedTasksDetails:function(s){var S={aSelectedTaskTypes:[],oSelectedTaskTypes:{},aItems:[],SupportsClaim:true,SupportsRelease:true,SupportsForward:true,SupportsResubmit:true,SupportsConfirm:true,bContainsConfirmableItem:false};var I,B,t,T,c,o;for(var i in s){B=s[i];t=B.getProperty("TaskSupports");T=B.getProperty("TaskDefinitionID");c=B.getProperty("InstanceID");o=B.getProperty("SAP__Origin");I={InstanceID:c,SAP__Origin:o,sContextPath:B.getPath()};S.aItems.push(I);if(!S.oSelectedTaskTypes[T]){S.oSelectedTaskTypes[T]={TaskDefinitionID:T,InstanceID:c,SAP__Origin:o};S.aSelectedTaskTypes.push(T);}if(S.SupportsClaim&&!t.Claim){S.SupportsClaim=false;}if(S.SupportsRelease&&!t.Release){S.SupportsRelease=false;}if(S.SupportsForward&&!t.Forward){S.SupportsForward=false;}if(S.SupportsResubmit&&!t.Resubmit){S.SupportsResubmit=false;}if(S.SupportsConfirm&&!t.Confirm){S.SupportsConfirm=false;}if(!S.bContainsConfirmableItem&&t.Confirm){S.bContainsConfirmableItem=true;}}return S;},getCommonDecisionsForMultipleTasks:function(l){if(l.length===0){return[];}else if(l.length===1){return l[0];}var I=l[0];for(var i=1;i<l.length;i++){I=this._getCommonDecisionsForTwoTasks(I,l[i]);if(I.length===0){break;}}return I;},_getCommonDecisionsForTwoTasks:function(A,c){var r=[];var i,j;var d=A.length;var f=c.length;for(i=0;i<d;i++){for(j=0;j<f;j++){if(A[i].DecisionKey===c[j].DecisionKey&&A[i].Nature===c[j].Nature){r.push(A[i]);}}}return r;},getEncodedURL:function(u){var c=u.split("?");u=c[0]+"?"+e(this.getQueryObject(c[1]));return u;},getQueryObject:function(Q){var p={},c,t;c=Q.split("&");q.each(c,function(i,s){t=this.splitString(s,"=");p[t[0]]=t[1];}.bind(this));return p;},splitString:function(s,S){var p=[],i=s.indexOf(S)+1;if(i){p[0]=s.split(S,1)[0];p[1]=s.substring(i);}return p;}});});
