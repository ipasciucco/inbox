/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/model/odata/ODataUtils","cross/fnd/fiori/inbox/util/CommonFunctions","sap/ui/model/odata/v2/ODataModel","sap/ui/base/ManagedObject","sap/ui/model/odata/ODataMetadata","sap/ui/model/odata/CountMode","sap/m/MessageBox"],function(L,U,O,C,a,M,b,c,d){"use strict";M.extend("cross.fnd.fiori.inbox.util.tools.ConnectionManager",{metadata:{properties:{identity:"string",configuration:"object",defaultConfiguration:"object",component:"object"}},initModels:function(){function e(P,A){(A||"").split("&").forEach(function(j){var i=j.indexOf("="),K=j,V="";if(i>=0){V=decodeURIComponent(K.slice(i+1));K=K.slice(0,i);}K=decodeURIComponent(K);if(K){P[K]=V;}});}function f(j){var w=JSON.parse(JSON.stringify(j));jQuery.each(w,function(i,x){x.fRequestFailed=j[i].fRequestFailed;});return w;}this.modelList={};this.mockServerList={};this.iRequestCount=0;var s=Array.isArray(this.getConfiguration().getServiceList())?f(this.getConfiguration().getServiceList()):null;var g=this.getConfiguration().getExcludedQueryStringParameters()||[];var h=this.getConfiguration().isMock();var t=this;var k=U.fromURL(window.location.href).get("sap-server");var l=U.fromURL(window.location.href).get("sap-host");var m=U.fromURL(window.location.href).get("sap-host-http");var n=U.fromURL(window.location.href).get("sap-client");var o=t.getComponent();var S=(o.getComponentData()||{}).startupParameters||{};var v=S["sap-system"]||{};var p=typeof v==="object"?v[0]:v;this.sErrorInStartMessage="";this.bIsComponentBase=!!o.setRouterSetCloseDialogs;this.bIsShowingMessage=false;if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()&&o&&o.getMetadata()){var q=o.getMetadata().getConfig(),r=q["sap.ca.serviceConfigs"]||[];var u=function(w,E){var x,y;var z=Array.isArray(E)?f(E):[];for(var i=0;i<w.length;i++){x=w[i];for(var j=0;j<z.length;j++){y=z[j];if(x.name==y.name){for(var A in y){x[A]=y[A];}z.splice(j,1);j--;}}}w=w.concat(z);return w;};if(r.length>0&&s!=null){s=u(s,r);}}if(s!=null){jQuery.each(s,function(i,j){function w(E,D){var F="Cannot load meta data for service "+D.serviceUrl,G=E.getParameter("statusCode"),H=t.getIdentity()||"cross.fnd.fiori.inbox.util.tools.ConnectionManager";G+=" (";G+=E.getParameter("statusText");G+=") - ";G+=E.getParameter("message");G+="\n";G+=E.getParameter("responseText");L.error(F,G,H);}var x=URI(j.serviceUrl),y=(j.useV2ODataModel===true);if(k!=null&&(g.indexOf("sap-server")===-1)){x.addSearch("sap-server",k);}else if(l!=null&&(g.indexOf("sap-host")===-1)){x.addSearch("sap-host",l);}else if(m!=null&&(g.indexOf("sap-host-http")===-1)){x.addSearch("sap-host-http",m);}if(n!=null&&(g.indexOf("sap-client")===-1)){x.addSearch("sap-client",n);}var z=x.toString();if(p){z=DataUtils.setOrigin(z,p);}var q={metadataUrlParams:{},json:true,loadMetadataAsync:j.loadMetadataAsync===true||y};e(q.metadataUrlParams,j.metadataParams);if(j.serviceUrl.indexOf("/sap/opu/")===0){var A;if(sap.ushell&&sap.ushell.Container){A=sap.ushell.Container.getUser().getLanguage();if(A&&!/^[A-Z]{2}$/i.test(A)){A=sap.ui.getCore().getConfiguration().getSAPLogonLanguage();}}else{A=U.fromURL(window.location.href).get("sap-language");}if(A&&g.indexOf("sap-language")<0){q.metadataUrlParams["sap-language"]=A;}}var B=y?new a(z,q):new a(z,q);if(q.loadMetadataAsync){B.attachMetadataLoaded({oModel:B,oService:j},function(E,P){t.checkModelMetaData(P.oModel,P.oService);},this);B.attachMetadataFailed({oModel:B,oService:j},function(E,P){w(E,P.oService);t.checkModelMetaData(P.oModel,P.oService);},this);}else{B.attachMetadataFailed(j,w,this);t.checkModelMetaData(B,j);}if(j.overrideGetPropertyMetadata&&B.oMetadata){B.oMetadata._getPropertyMetadata=function(E,P){P=P.replace(/^\/|\/$|\)$|\w*\(/g,"");return b.prototype._getPropertyMetadata.apply(this,[E,P]);};}if((j.useBatch)&&!h){B.setUseBatch(true);}if(j.countSupported){if(y){B.setDefaultCountMode(c.Request);}else{B.setCountSupported(true);}}else if(y){B.setDefaultCountMode(c.Inline);}else{B.setCountSupported(false);}if(j.sDefaultBindingMode){B.setDefaultBindingMode(j.sDefaultBindingMode);}if(j.fRequestFailed){B.attachRequestFailed(null,j.fRequestFailed);}else{B.attachRequestFailed(null,jQuery.proxy(t.handleRequestFailed,t));}if(j.noBusyIndicator==true){B.attachRequestSent(null,jQuery.proxy(t.handleRequestSentInner,t));B.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompletedInner,t));}else{B.attachRequestSent(null,jQuery.proxy(t.handleRequestSent,t));B.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompleted,t));}if(j.isDefault){t.modelList[undefined]=B;t.setDefaultConfiguration(j);}else{t.modelList[j.name]=B;}});}},checkModelMetaData:function(m,s){if(!m.getServiceMetadata()){var i=this.getProperty("configuration").oApplicationFacade.oApplicationImplementation.UilibI18nModel.getResourceBundle();this.sErrorInStartMessage=i.getText("ERROR_MSG_NO_METADATA",[s.name]);var S={message:this.sErrorInStartMessage,details:i.getText("ERROR_DETAIL_NO_METADATA",[s.serviceUrl])};this.showMessageBox(S);return;}},setIdentity:function(i){var o=this.getIdentity();if(o!=i){this.setProperty("identity",i);}},getModel:function(n){return this.modelList[n];},handleRequestSent:function(e){this.handleRequestSentInner(e);},handleRequestSentInner:function(e){this.iRequestCount++;L.info("Connection Manager","Request sent");},handleRequestFailed:function(e){L.error("Connection Manager","Failed to load data");var r=e.getParameter("response"),s={message:e.getParameter("message")||(r&&r.message),details:e.getParameter("responseText")||(r&&r.responseText)};this.showMessageBox(s);},handleRequestCompleted:function(e){this.handleRequestCompletedInner(e);},handleRequestCompletedInner:function(e){if(e.getParameter("success")){L.info("Connection Manager","Request succesfully completed");}else{L.info("Connection Manager","Request completed with errors",e.getParameter("message"));}},showMessageBox:function(s){if(this.bIsShowingMessage){return;}this.bIsShowingMessage=true;if(this.bIsComponentBase){var o=this.getComponent();var i=o._bRouterCloseDialogs;o.setRouterSetCloseDialogs(false);}d.error(s.message,{details:C.fnRemoveHtmlTags(s.details),onClose:jQuery.proxy(function(){this.bIsShowingMessage=false;if(this.bIsComponentBase){o.setRouterSetCloseDialogs(i);}},this)});}});cross.fnd.fiori.inbox.util.tools.ConnectionManager.getNewInstance=function(i,o,D,e){var f=new cross.fnd.fiori.inbox.util.tools.ConnectionManager({identity:i,configuration:o,defaultConfiguration:D,component:e});f.initModels();return f;};return cross.fnd.fiori.inbox.util.tools.ConnectionManager;});
