/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/Sorter","sap/m/ViewSettingsItem","cross/fnd/fiori/inbox/model/formatter","cross/fnd/fiori/inbox/util/Comparators","cross/fnd/fiori/inbox/util/Utils"],function(U,S,V,F,C,a){"use strict";return U.extend("cross.fnd.fiori.inbox.util.TableOperationsHelper",{_oTableOperations:null,_oView:null,_oCustomSortItems:{},_sPreviousSingleTaskDefinitionFilter:null,constructor:function(t,v,b){this._oResourceBundle=v.getController().getResourceBundle();this._oTableOperations=t;this._oView=v;this._taskListCustomAttributeHelper=b;},openTableOperationsDialog:function(o){var d=this._getTableOperationsDialog();if(this._oView.byId("taskDefinitionFilter").getSelectedItems().length===1){var c=this._oView.byId("taskDefinitionFilter").getSelectedItems()[0].getText();if(!this._sPreviousSingleTaskDefinitionFilter){this._addCustomAtrributesSorters();}else if(this._sPreviousSingleTaskDefinitionFilter!==c){this._removeCustomAtrributesSorters();this._addCustomAtrributesSorters();}this._sPreviousSingleTaskDefinitionFilter=c;}else{this._removeCustomAtrributesSorters();this._sPreviousSingleTaskDefinitionFilter=null;}var l=this._oTableOperations.getSorters();if(l.length>0){var b=l[0].bDescending;if(l[0].sPath==="PriorityNumber"){b=!b;}d.setSelectedSortItem(l[0].sPath);d.setSortDescending(b);}d.open(o);return d;},_getTableOperationsDialog:function(){if(!this._oTableOperationsDialog){this._oTableOperationsDialog=sap.ui.xmlfragment("cross.fnd.fiori.inbox.fragments.TableOperationsDialog",this);this._oView.addDependent(this._oTableOperationsDialog);}return this._oTableOperationsDialog;},onTableOperationsDialogConfirmed:function(e){var p=e.getParameters();this.prepareTableSortingOperation(p);this.prepareTableGroupingOperation(p);this._oTableOperations.applyTableOperations("CustomAttrColumnGrp");var P=this._oView.byId("page");if(P){P.getScrollDelegate().scrollTo(0,0,0);}},setColumnSortIndicator:function(c,o){var b=this._oView.byId("table").getColumns(),d=b.length;for(var i=0;i<d;i++){if(b[i].getId().indexOf(c)>-1){b[i].setSortIndicator(o);}else{b[i].setSortIndicator("None");}}},resetViewSettingsDialog:function(){this.resetSortDialog();this.resetGroupDialog();},resetSortDialog:function(){var i,s=this._getTableOperationsDialog().getSortItems(),d=this._oTableOperations.getDefaultSortItemKey();for(i=0;i<s.length;i++){if(s[i].getKey()===d)break;}var p={sortItem:s[i],sortDescending:true};this.prepareTableSortingOperation(p);},resetGroupDialog:function(){this._getTableOperationsDialog().setSelectedGroupItem();this._getTableOperationsDialog().setGroupDescending(true);var p={groupItem:new sap.m.ViewSettingsItem(),groupDescending:true};this.prepareTableGroupingOperation(p);},prepareTableSortingOperation:function(p){var s=p.sortItem.getKey(),b,c=p.sortItem.getId().replace(/Sort$/,"");if(p.groupItem&&s===p.groupItem.getKey()){b=p.groupDescending;}else{b=p.sortDescending;}if(b){this.setColumnSortIndicator(c,"Descending");}else{this.setColumnSortIndicator(c,"Ascending");}if(s==="PriorityNumber"){this._oTableOperations.addSorter(new S(s,!b,false,C.fnPriorityComparator));}else{this._oTableOperations.addSorter(new S(s,b));}},prepareTableGroupingOperation:function(p){var s,f,g;if(p.groupItem&&p.groupItem.getKey()!==""){s=p.groupItem.getKey();f="fn"+s;g=p.groupDescending;if(s==="PriorityNumber"){this._oTableOperations.setGrouping(new S(s,!g,(this._oGroupFunctions[f].bind(this)),C.fnPriorityComparator));}else{this._oTableOperations.setGrouping(new S(s,g,(this._oGroupFunctions[f].bind(this))));}}else{this._oTableOperations.removeGrouping();}},_oGroupFunctions:{fnTaskDefinitionName:function(l){var k=l.getProperty("TaskDefinitionName");var f=k;return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_TaskDefinitionName"),f,k);},fnPriorityNumber:function(l){var k=l.getProperty("PriorityNumber");var f=F.formatPriorityForGrouping(k,this._oView);return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_PriorityColumnTitle"),f[0],f[1]);},fnCompletionDeadLine:function(l){var d=l.getProperty("CompletionDeadLine");var f=this._oResourceBundle.getText("GroupTitle_NoCompletionDeadLine.none");if(d!=null){var b=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy",relative:true,relativeScale:"auto"},sap.ui.getCore().getConfiguration().getLocale());f=b.format(new Date(d));}return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_DueColumnTitle"),f,f);},fnCreatedOn:function(l){var c=l.getProperty("CreatedOn");var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy",relative:true,relativeScale:"auto"},sap.ui.getCore().getConfiguration().getLocale());var f=d.format(new Date(c));return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_CreatedOnColumnTitle"),f,f);},fnCreatedByName:function(l){var c=l.getProperty("CreatedByName");return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_CreatedByColumnTitle"),c,c);},fnStatus:function(l){var s=l.getProperty("Status");return this._getNameGrouper(this._oResourceBundle.getText("GroupTitle_StatusColumnTitle"),F.formatStatusForGrouping(s,this._oView),F.formatStatusForGrouping(s,this._oView));}},_getNameGrouper:function(l,f,k){var t=l+": "+f;return{key:k,text:t};},_addCustomAtrributesSorters:function(){var c=this._taskListCustomAttributeHelper.getCustomAttributeList();for(var i=0;i<c.length;i++){this._addCustomSortItem(c[i]);}},_removeCustomAtrributesSorters:function(){var _=Object.keys(this._oCustomSortItems);for(var i=0;i<_.length;i++){var k=_[i];this._removeCustomSortItem(k);}},_addCustomSortItem:function(c){var d=this._getTableOperationsDialog();var e=encodeURIComponent(c.Name);var s=this._oCustomSortItems[c.Name];if(s){d.addSortItem(s);}else{s=new V(a.genSafeId(c,true)+"Sort",{key:e,text:c.Label});d.addSortItem(s);this._oCustomSortItems[c.Name]=s;}},_removeCustomSortItem:function(k){var d=this._getTableOperationsDialog();var s=this._oCustomSortItems[k];if(s){d.removeSortItem(s);this._oCustomSortItems[k].destroy();delete this._oCustomSortItems[k];}}});});
