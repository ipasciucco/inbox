/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/m/Column","cross/fnd/fiori/inbox/util/CustomAttributeComparator","sap/ui/Device","sap/m/Label","sap/m/TimePicker","sap/m/library","sap/m/Text","sap/m/DateRangeSelection","sap/ui/comp/filterbar/FilterGroupItem","sap/m/MultiInput","cross/fnd/fiori/inbox/model/models","cross/fnd/fiori/inbox/model/formatter","cross/fnd/fiori/inbox/util/Utils"],function(U,C,a,D,L,T,l,b,c,F,M,m,d,e){"use strict";var P=l.PopinDisplay;return U.extend("cross.fnd.fiori.inbox.util.TaskListCustomAttributeHelper",{_aCustomAttributeList:[],constructor:function(o,v,t,f){this._oView=v;this._oController=o;this._oTable=t;this._oTableOperations=f;this._customColumns={};this._customFilters={};this._visibleCustomFilters=[];},showCustomAttributeColumns:function(t){this._oController._aCustomStringAttributes=[];this._aCustomAttributeList=this._getCustomAttributes(t);var f=this._aCustomAttributeList.length>10;for(var g in this._customColumns){var E=false;for(var j=0;j<this._aCustomAttributeList.length;j++){if(g===this._aCustomAttributeList[j].Name){E=true;break;}}if(!E){this.destroy(g);}}var h;var i;var n;for(var k=0;k<this._aCustomAttributeList.length;k++){i=this._aCustomAttributeList[k].Format?this._aCustomAttributeList[k].Format:null;h=this._addColumn(this._aCustomAttributeList[k],!f);if(h===null){continue;}if((i===null)&&(this._aCustomAttributeList[k].Type.toLowerCase()==="string"||this._aCustomAttributeList[k].Type.toLowerCase()==="edm.string")){this._oController._aCustomStringAttributes.push(this._aCustomAttributeList[k].Label);}if(this._oView.getModel("worklistView").getProperty("/caShowCustomFilters")){n=this._addCustomFilterItem(this._aCustomAttributeList[k]);}}if(sap.ushell.Container){this._oController._oTablePersoController.refresh();}this._oTable.bindItems(this._oTable.getBindingInfo("items"));this._oTable.getBinding("items").refresh();this._oController._initPlaceholderAndTooltip();this._oView.getModel("worklistView").setProperty("/caLimitInfoVisible",f);this._oTable.setProperty("autoPopinMode",false);var o=this;setTimeout(function(){o._oTable.setProperty("autoPopinMode",true);},0);},hideCustomAttributeColumns:function(r){var f=Object.keys(this._customColumns);for(var i=0;i<f.length;i++){var g=f[i];this.destroy(g);}this._oController._aCustomStringAttributes=[];this._oController._initPlaceholderAndTooltip();this._oView.getModel("worklistView").setProperty("/caLimitInfoVisible",false);if(r){if(sap.ushell.Container){this._oController._oTablePersoController.refresh();}this._oTable.bindItems(this._oTable.getBindingInfo("items"));this._oTableOperations.setSortChanged(true);this._oTableOperations.setFilterChanged(true);this._oTableOperations.applyTableOperations();this._oTable.getBinding("items").refresh();}},destroyCustomFilters:function(){var f=Object.keys(this._customFilters);for(var i=0;i<f.length;i++){this._destroyCustomFilterItem(f[i]);}},setFilterbar:function(f,g){this._filterbarController=f;this._oFilterBar=g;},destroy:function(f){var g=this._customColumns[f];if(g){g.column.destroy();g.cell.destroy();}delete this._customColumns[f];this._destroyCustomFilterItem(f);},getVisibleCustomFilters:function(){return this._visibleCustomFilters;},_getCustomAttributes:function(t){var f=m.getTaskDefinitionModel().getData();var g=[];for(var h in f){var i=f[h];if(t.includes(i.TaskDefinitionID)){for(var j in i.CustomAttributeDefinitionData){g.push(i.CustomAttributeDefinitionData[j]);}}}return g;},_addColumn:function(f,v){v=v!=null?v:true;var i=["CustomNumberValue","CustomNumberUnitValue","CustomObjectAttributeValue","CustomCreatedBy","CA_CustomNumberValue","CA_CustomNumberUnitValue","CA_CustomObjectAttributeValue","CA_CustomCreatedBy"];if(i.indexOf(f.Name)===-1){var g=this._customColumns[f.Name];if(!g){g=this._addCustomAttributeColumn(f,v);this._customColumns[f.Name]=g;}this._oTable.addColumn(g.column);var t=this._oTable.getBindingInfo("items").template;t.addCell(g.cell);return g;}else{return null;}},_addCustomFilterItem:function(f){var g=this._customFilters[f.Name];if(!g){g=this._addCustomFilter(f);this._customFilters[f.Name]=g;}return g;},_destroyCustomFilterItem:function(f){var g=this._customFilters[f];if(g){g.destroy();}delete this._customFilters[f];},_addCustomAttributeColumn:function(f,v){v=v!=null?v:true;var i=e.genSafeId(f,true);var o=new C(i+"Column",{header:new L(i+"Lbl",{text:f.Label,tooltip:f.Label}),popinDisplay:P.Inline,minScreenWidth:"Tablet",demandPopin:true,visible:v});var g=new b(i+"Txt",{maxLines:1,tooltip:{path:"taskModel>"+encodeURIComponent(f.Name),formatter:d.getCustomAttributeTypeWorklistFormatter(f.Type,this._oView,f.Format)},text:{path:"taskModel>"+encodeURIComponent(f.Name),formatter:d.getCustomAttributeTypeWorklistFormatter(f.Type,this._oView,f.Format)}});g.data({Type:f.Type});return{cell:g,column:o};},_addCustomFilter:function(f){var i=e.genSafeId(f,true);var t=f.Type?a.fnMapDataTypes(f.Type):"";var g,o;if(t==="Edm.DateTime"){o=new c(i+"Filter",{name:encodeURIComponent(f.Name),delimiter:"-"});o.sCustomAttributeType=t;o.fnCustomAttributeComparator=a.getCustomAttributeComparator(t);g=new F(i+"FI",{groupName:"basic",visibleInFilterBar:true,label:f.Label,name:encodeURIComponent(f.Name),partOfCurrentVariant:true,control:o});}else if(t==="Edm.Time"){o=new T(i+"Filter",{name:encodeURIComponent(f.Name)});o.sCustomAttributeType=t;o.fnCustomAttributeComparator=a.getCustomAttributeComparator(t);g=new F(i+"FI",{groupName:"basic",visibleInFilterBar:true,label:f.Label,name:encodeURIComponent(f.Name),partOfCurrentVariant:true,control:o});}else{o=new M(i+"Filter",{name:encodeURIComponent(f.Name),valueHelpRequest:[f.Label,this._filterbarController.onValueHelpRequest],valueHelpOnly:true}).data({type:t});o.sCustomAttributeType=t;o.fnCustomAttributeComparator=a.getCustomAttributeComparator(t);g=new F(i+"FI",{groupName:"basic",visibleInFilterBar:true,label:f.Label,name:encodeURIComponent(f.Name),partOfCurrentVariant:true,control:o});}if(g){this._oFilterBar.addFilterGroupItem(g);}return g;},getCustomAttributeList:function(){return this._aCustomAttributeList;}});});
