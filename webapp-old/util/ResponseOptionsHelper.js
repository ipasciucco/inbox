/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["cross/fnd/fiori/inbox/model/models","cross/fnd/fiori/inbox/model/ModelsHelper","cross/fnd/fiori/inbox/util/Utils","cross/fnd/fiori/inbox/util/ConfirmationDialogManager"],function(m,M,U,C){"use strict";return{_tasksPendingRemoval:[],processCustomAction:function(d,b,t,c,s){delete this._bCompletedTaskIsDifferentFromDetail;if(typeof c==="undefined"){c=this._sPressedItemContextPath;}else if(c!==this._sPressedItemContextPath){this._bCompletedTaskIsDifferentFromDetail=true;}var i=c.slice(c.lastIndexOf("/")+1);i=parseInt(i,10);if(!isNaN(i)){this._tasksPendingRemoval.push({"index":i,"SAP__Origin":t.SAP__Origin});}var D={DecisionKey:d,InstanceID:t.InstanceID,TaskDefinitionID:t.TaskDefinitionID,SAP__Origin:t.SAP__Origin};var k=M.getKeyForResponseOption(D);var r=m.getResponseOptionsModel().getData()[k];var a=!!r.CommentMandatory;var e=!!r.CommentSupported;var f={"show":!!r.ReasonRequired&&(r.ReasonRequired==="REQUIRED"||r.ReasonRequired==="OPTIONAL")&&r.ReasonDefinitionsData.length>0,"required":r.ReasonRequired==="REQUIRED","reasonOptions":[].concat(r.ReasonDefinitionsData)};C.showDecisionDialog({question:s.getResourceBundle().getText("XMSG_DECISION_QUESTION",b),textAreaLabel:s.getResourceBundle().getText("XFLD_TextArea_Decision"),showNote:e,title:s.getResourceBundle().getText("XTIT_SUBMIT_DECISION"),confirmButtonLabel:s.getResourceBundle().getText("XBUT_SUBMIT"),noteMandatory:a,i18nModel:s.getModel("i18n"),reasonOptionsSettings:f,confirmActionHandler:function(D,n,R){m.callCustomAction(D,this.customActionSuccess.bind(this),this.customActionError.bind(this,b),n,R);}.bind(this,D),cancelActionHandler:this.cancelActionHandler.bind(this)});s.getOwnerComponent().getErrorHandler().preventErrorMessageBoxToOpen(true);},customActionSuccess:function(d,r){var t=this._tasksPendingRemoval.shift();var a=r.data.Status;if(a==="COMPLETED"){for(var i=0;i<this._tasksPendingRemoval.length;i++){if(this._tasksPendingRemoval[i].index>t.index){this._tasksPendingRemoval[i].index--;}}m.getTaskModel().getData().results.splice(t.index,1);m.getTaskModel().getData().__count--;m.getTaskModel().updateBindings();}m.fireEvent("customActionSuccess",{"taskStatus":a,"taskToRemove":t});},customActionError:function(a,e){var t=this._tasksPendingRemoval.shift();var b=m.getTaskModel().getData().results[t.index];var s=[b],S=[],E,r;if(U.isJson(e.responseText)){r=JSON.parse(e.responseText);E=[{sTaskTitle:b.TaskTitle,InstanceID:b.InstanceID,sMessage:r.error.message.value,sErrorCode:r.error.code,sErrorBody:r.error.message.value}];}else if(U.isString(e.responseText)){E=[{sTaskTitle:b.TaskTitle,InstanceID:b.InstanceID,sMessage:U.isString(e.message)?e.message:"Error message cannot be parsed",sErrorCode:U.isString(e.statusCode)?e.statusCode:"Error code cannot be parsed",sErrorBody:e.responseText}];}m.fireEvent("customActionError",{"sCurrentAction":a,"aSuccessList":S,"aErrorList":E,"aSelectedTasks":s});},cancelActionHandler:function(){this._tasksPendingRemoval.pop();}};});
