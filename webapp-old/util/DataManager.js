/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","sap/base/util/UriParameters","sap/m/Button","sap/m/MessageBox","sap/m/MessageToast","sap/ui/base/EventProvider","sap/ui/Device","sap/ui/thirdparty/jquery","cross/fnd/fiori/inbox/util/CommonFunctions","cross/fnd/fiori/inbox/util/Substitution"],function(L,a,U,B,M,b,E,D,q,C,S){"use strict";return E.extend("cross.fnd.fiori.inbox.util.DataManager",{sMode:"TABLET",oModel:null,oPostActionModel:null,_oScenarioConfig:null,FUNCTION_IMPORT_CONFIRM:"Confirm",FUNCTION_IMPORT_DECISION:"Decision",FUNCTION_IMPORT_DECISIONOPTIONS:"DecisionOptions",FUNCTION_IMPORT_REASONOPTIONS:"ReasonOptions",FUNCTION_IMPORT_RESUBMIT:"Resubmit",FUNCTION_IMPORT_ENABLESUBSTITUTIONRULE:"EnableSubstitutionRule",ACTION_SUCCESS:"Success",ACTION_FAILURE:"Failure",M_EVENTS:{ItemRemoved:"itemRemoved",ActionPerformed:"actionPerformed",refreshDetails:"refreshDetails"},aSystemInfoCollection:null,aSubstitutionProfilesCollection:null,oCustomAttributeDefinitions:{},oUIExecutionLinks:{},oDecisionOptions:{},oDescriptions:{},oCurrentUserImageAvailability:{},oTaskDefinitionModel:{},sScenarioId:null,sClientScenario:null,bAllItems:null,userSearch:true,bOutbox:false,tableView:false,tableViewOnPhone:false,bIsMassActionEnabled:null,bIsQuickActionEnabled:null,sDefaultSortBy:null,iListSize:null,bEnablePaging:false,sOperationMode:"Server",iPageSize:30,iCacheSize:null,bShowAdditionalAttributes:false,bSubstitution:true,bShowLog:true,bFullWidth:false,bTaskTitleInHeader:false,bStandaloneDetailDeep:false,bDebug:false,bDetailPageLoaded:false,bDetailPageLoadedViaDeepLinking:false,bIsDeepLinkingURLCall:false,sCustomAttributeDefinitionNavProperty:"CustomAttributeDefinitionData",sClaimAction:"Claim",sReleaseAction:"Release",sResumeAction:"CancelResubmission",sTaskDefinitionCollectionName:"TaskDefinitionCollection",sStatusCompleted:"COMPLETED",sDefaultSortForOutbox:"CompletedOn",sDeafultSortForInbox:"CreatedOn",oServiceMetaModel:null,oEventBus:null,sTaskInstanceID:null,sSapOrigin:null,bPropogateSapURLParameters:true,constructor:function(c){E.apply(this);this.oCacheStore={"DecisionOptions":this.oDecisionOptions,"UIExecutionLink":this.oUIExecutionLinks,"Description":this.oDescriptions};var o,s;if(c){o=c.getOwnerComponent().getComponentData();if(o){s=o.startupParameters;this._getURLParametersfromStartUpParameters(s);}else{this._getURLParameters();}this.oPostActionModel=c.getOwnerComponent().getModel("POSTACTION");}this.oi18nResourceBundle=c.getResourceBundle();this.oEventBus=c.getOwnerComponent().getEventBus();this.setDetailPageLoaded(false);if(!this.iListSize){this.iListSize=this.bOutbox?300:100;}this.bDebug=U.fromURL(window.location.href).get("sap-ui-debug")=="true"?true:false;},setModel:function(m){this.oModel=m;if(this.oModel){this.oModel.setUseBatch(true);this.oModel.setRefreshAfterChange(false);this.oModel.attachRequestCompleted(this.handleRequestCompleted.bind(this));}},handleRequestCompleted:function(e){if(e){var r=e.getParameter("url");if(r&&r.split("?")[0]==="TaskCollection"&&e.getSource().oProcessingMultiSelect&&e.getSource().oProcessingMultiSelect.bProcessing&&e.getParameters().success){cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().publish("cross.fnd.fiori.inbox.dataManager","multiSelectFilterCompleted",e.getSource().oProcessingMultiSelect);}}this.fnShowReleaseLoader(false);},handleRequestFailed:function(e){if(e){var r=e.getParameter("response");var R=e.getParameter("url");var s=R?R.split("?")[0]:null;if(s==="TaskDefinitionCollection"&&r&&r.responseText){var p;if(r.statusCode=="429"){var P=JSON.parse(r.responseText);if(P&&P.error&&P.error.code==="bpm.workflowruntime.rate.limit.exceeded"){p={message:this.oi18nResourceBundle.getText("DataManager.rateLimitError"),responseText:r.responseText};this.showLocalErrorMessage(p);}}if(r.statusCode=="509"){p={message:this.oi18nResourceBundle.getText("DataManager.rateLimitError"),responseText:r.responseText};this.showLocalErrorMessage(p);}}if(s==="TaskCollection"){this.handleTaskCollectionFailed(e);}}this.fnShowReleaseLoader(false);},handleTaskCollectionFailed:function(e){var d=e.getParameter("response")?e.getParameter("response").responseText:"";var o={customMessage:{message:this.oi18nResourceBundle.getText("dialog.error.task_collection"),details:d},oEvent:e};this.oDataRequestFailed(o);if(!e.getSource().oProcessingMultiSelect){this.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","taskCollectionFailed");}else{this.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","multiSelectFilterFailed");}},attachItemRemoved:function(d,f,l){this.attachEvent(this.M_EVENTS.ItemRemoved,d,f,l);return this;},attachRefreshDetails:function(d,f,l){this.attachEvent(this.M_EVENTS.refreshDetails,d,f,l);return this;},fireRefreshDetails:function(A){this.fireEvent(this.M_EVENTS.refreshDetails,A);return this;},fireItemRemoved:function(A){this.fireEvent(this.M_EVENTS.ItemRemoved,A);return this;},attachActionPerformed:function(d,f,l){this.attachEvent(this.M_EVENTS.ActionPerformed,d,f,l);return this;},fireActionPerformed:function(A){if(this.getPagingEnabled()){this.oModel.refresh();}this.fireEvent(this.M_EVENTS.ActionPerformed,A);return this;},initTaskDefnandCustomAttrDefnnModel:function(d){var m=cross.fnd.fiori.inbox.util.tools.Application.getImpl().oCurController.MasterCtrl;if(m&&m.getView().getModel("taskDefinitionsModel")){m.getView().getModel("taskDefinitionsModel").setData(d.results);}},fetchTaskDefinitionsandCustomAttributeDefinitions:function(s){var t=this;var c="/"+t.sTaskDefinitionCollectionName;var e={$expand:t.sCustomAttributeDefinitionNavProperty};var f=function(g,r){t.oCustomAttributeDefinitions={};var R=g.results;if(Array.isArray(R)&&R.length>0){q.each(R,function(i,T){t.oCustomAttributeDefinitions[T.TaskDefinitionID]=T.CustomAttributeDefinitionData.results;});}s(g);};var d=function(o){t.oDataRequestFailed(o);};this.oDataRead(c,e,f,d,"taskDefn");},loadInitialAppData:function(s){if(!(this.sScenarioId||this.sClientScenario)||!this.oModel){return null;}var t=this;if(this.sScenarioId){var f="(ConsumerType eq '"+a(this.sMode)+"') and (UniqueName eq '"+a(this.sScenarioId)+"')";var c=function(h){if(h.hasOwnProperty("__batchResponses")&&h.__batchResponses.length===2){var j=[];var F=h.__batchResponses[0];if(F.hasOwnProperty("data")&&F.statusCode>="200"&&F.statusCode<"300"){t._processFilterOptionsResult(F.data);}else if(F.hasOwnProperty("response")&&F.response.statusCode>="400"){j.push(JSON.parse(F.response.body));}var k=h.__batchResponses[1];if(k.hasOwnProperty("data")&&k.statusCode>="200"&&k.statusCode<"300"){s(t._processConsumerScenarioResult(k.data));}else if(k.hasOwnProperty("response")&&k.response.statusCode>="400"){j.push(JSON.parse(k.response.body));}t._handleBatchErrors(j);}};var e=function(h){t.oDataRequestFailed(h);};var r=["/FilterOptionCollection","/ConsumerScenarioCollection"];t.fireBatch({aPaths:r,aUrlParameters:["","$filter="+encodeURIComponent(f)],sMethod:"GET",sBatchGroupId:"FilterOptionsAndConsumerScenarioCollection",numberOfRequests:r.length,fnSuccessCallback:c,fnErrorCallback:e});}else if(this.sClientScenario){var d=this.sClientScenario.trim().split(",");for(var i=(d.length-1);i>=0;i--){d[i]=d[i].trim();if(d[i].length===0){d.splice(i,1);}}if(d.length===0){this._clientScenarioRequestFailed();return;}var o=new Object();o.Origin="";o.TaskDefinitionIDs=d;var g=this.getScenarioConfig();g.ScenarioServiceInfos=[o];this._oScenarioConfig=g;s(g);}},fireBatch:function(p,u){var m=u?this.oPostActionModel:this.oModel;if(m.hasPendingChanges()){m.resetChanges();}m.setDeferredBatchGroups([p.sBatchGroupId]);var P;var e={batchGroupId:p.sBatchGroupId};for(var i=0;i<p.numberOfRequests;i++){if(p.aUrlParameters){e.urlParameters=p.aUrlParameters[i];}if(p.aProperties){e.properties=p.aProperties[i];}if(p.sPath){P=p.sPath;}else if(p.aPaths){P=p.aPaths[i];}if(!P.startsWith("/")){P="/"+P;}if(p.sMethod==="GET"){m.read(P,e);}else if(p.sMethod==="POST"){e.changeSetId="changeSetId"+i;m.createEntry(P,e);}else if(p.sMethod==="DELETE"){e.changeSetId="changeSetId"+i;m.remove(P,e);}else if(p.sMethod==="FUNCTIONIMPORT"){e.changeSetId="changeSetId"+i;e.method="POST";m.callFunction(P,e);}}m.submitChanges({batchGroupId:p.sBatchGroupId,success:p.fnSuccessCallback,error:p.fnErrorCallback});},_handleBatchErrors:function(e,c){if(e.length>0){var o=null;if(c){var d="";q.each(e,function(g,o){if(d.localeCompare(this.getErrorMessage(o)+"\n")){d+=this.getErrorMessage(o)+"\n";}}.bind(this));o={customMessage:{message:c,details:d}};}else{var m="";var s="";for(var i=0;i<e.length;i++){if(e[i].hasOwnProperty("error")){m+=e[i].error.message.value;}else if(e[i].hasOwnProperty("response")){m+=e[i].message;var f=JSON.parse(e[i].response.body);s+=f.error.message.value+"\n";}if(i<e.length-1){m+="\n";}}o={message:m,response:{body:s}};}this.oDataRequestFailed(o);}},processListAfterAction:function(o,i){cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().publish("cross.fnd.fiori.inbox","storeNextItemsToSelect",{"sOrigin":o,"sInstanceID":i});},_processConsumerScenarioResult:function(d){if(d.results.length===0){this._scenarioRequestFailed();return;}var m=new RegExp(";o=([A-Z0-9_]+)/.+\\?\\$filter=(.+)");var f=new RegExp("TaskDefinitionID eq '(.+)'");var c={};var s={};q.each(d.results,function(I,e){var o=s[e.UniqueName];if(!o){o=e;o.ScenarioServiceInfos=[];s[o.UniqueName]=o;}else{o.TotalItems=o.TotalItems+e.TotalItems;}var r=m.exec(e.ScenarioServiceURL);if(r){var O=r[1];var t=[];var F=r[2].split(" or ");for(var i=0;i<F.length;i++){r=f.exec(F[i]);if(r){t.push(r[1]);}}if(t.length>0){var g={Origin:O,TaskDefinitionIDs:t};o.ScenarioServiceInfos.push(g);}}});q.each(s,function(i,o){c=o;});this._oScenarioConfig=c;return c;},getScenarioConfig:function(){var c=this._oScenarioConfig;if(c==null){c={};}c.AllItems=this.bAllItems;if(this.bIsMassActionEnabled!=null){c.IsMassActionEnabled=this.bIsMassActionEnabled;}if(c.IsMassActionEnabled===undefined){c.IsMassActionEnabled=true;}if(this.bIsQuickActionEnabled!=null){c.IsQuickActionEnabled=this.bIsQuickActionEnabled;}if(c.IsQuickActionEnabled===undefined){c.IsQuickActionEnabled=true;}if(this.sDefaultSortBy!=null){c.SortBy=this.sDefaultSortBy;}if(!c.SortBy){c.SortBy=this.bOutbox?this.sDefaultSortForOutbox:this.sDeafultSortForInbox;}if(!c.DisplayName){if(c.AllItems){c.DisplayName=this.oi18nResourceBundle.getText("ALL_ITEMS_SCENARIO_DISPLAY_NAME");}else if(this.sClientScenario){c.DisplayName=this.oi18nResourceBundle.getText("CLIENT_SCENARIO_DISPLAY_NAME");}}return c;},getSubstitutionEnabled:function(){return this.bSubstitution;},getShowLogEnabled:function(){return this.bShowLog;},getFullWidth:function(){return this.bFullWidth;},getTableViewOnPhone:function(){return this.tableViewOnPhone;},getTableView:function(){return this.tableView;},getListSize:function(){return this.iListSize;},setListSize:function(v){this.iListSize=v;},getPageSize:function(){return this.iPageSize;},getCacheSize:function(){return this.iCacheSize;},getOperationMode:function(){return this.sOperationMode;},getPagingEnabled:function(){return this.bEnablePaging;},isForwardUserSettings:function(){return this.bPropogateSapURLParameters;},getTaskTitleInHeader:function(){return this.bTaskTitleInHeader;},getStandaloneDetailDeep:function(){return this.bStandaloneDetailDeep;},_scenarioRequestFailed:function(){var e={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.scenarioReadFailed"),details:this.oi18nResourceBundle.getText("DataManager.scenarioReadFailedDetail")}};this.oDataRequestFailed(e);},_clientScenarioRequestFailed:function(){var e={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.clientScenarioReadFailed"),details:this.oi18nResourceBundle.getText("DataManager.clientScenarioReadFailedDetail",this.sClientScenario)}};this.oDataRequestFailed(e);},sendMultiAction:function(f,I,d,n,r,o,c,h){var p=[];var t=this;var T;var e=[];for(var g in I){T=I[g];var P={SAP__Origin:"'"+encodeURIComponent(T.SAP__Origin)+"'",InstanceID:"'"+T.InstanceID+"'"};if(d&&d.DecisionKey){P.DecisionKey="'"+d.DecisionKey+"'";}if(n&&n.length>0){P.Comments="'"+n+"'";}if(r){P.ReasonCode="'"+r+"'";}p.push(P);}var s=function(k){if(h){t.fnShowReleaseLoader(false);}var l=k.__batchResponses;var m=[];var u=[];for(var i=0;i<l.length;i++){var v=l[i];var w=I[i];var x=false;if(v.hasOwnProperty("__changeResponses")){var y=v.__changeResponses[0];if(y.statusCode>="200"&&y.statusCode<"300"){x=true;e.push({index:i,oData:y.data});}}if(x){w.message=t.oi18nResourceBundle.getText("multi.processed");m.push(w);}else if(v.response){w.message=JSON.parse(v.response.body).error.message.value;u.push(w);}}if(o){o(m,u,e);}};var j=function(i){if(h){t.fnShowReleaseLoader(false);}t.oDataRequestFailed(i);if(c){c(i);}};if(h){t.fnShowReleaseLoader(true);}t.fireBatch({sPath:f,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"SendMultiAction",numberOfRequests:I.length,fnSuccessCallback:s,fnErrorCallback:j});},readDataOnTaskSelection:function(c,e,t,o,I,T,d,s){if(!c||!o||!I){return null;}var f=this;var r=[];var p=[];var g="";var i=0;r.push(c);for(i=0;i<e.length;i++){if(g!==""){g=g+",";}g=g+e[i];}if(g!==""){p.push({$expand:g,$select:g+",Status,TaskTitle"});}else{p.push("");}if(!f.oCustomAttributeDefinitions[T]){r.push("/"+f.sTaskDefinitionCollectionName+"(SAP__Origin='"+a(o)+"',TaskDefinitionID='"+a(T)+"')"+"/"+f.sCustomAttributeDefinitionNavProperty);p.push("");}if(t!=null){for(i=0;i<t.length;i++){r.push(c+"/"+t[i]+"/$count");p.push("");}}if(!this.bOutbox&&d.Status!=="COMPLETED"&&d.Status!=="FOR_RESUBMISSION"){r.push("/"+this.FUNCTION_IMPORT_DECISIONOPTIONS);p.push({SAP__Origin:"'"+o+"'",InstanceID:"'"+I+"'"});}else{f.oDecisionOptions[o+T]=[];}var h=function(r,k){f.setDetailPageLoaded(true);var v={};v.bValue=false;f.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","showReleaseLoaderOnInfoTab",v);if(k.hasOwnProperty("__batchResponses")&&k.__batchResponses.length>0){var l=q.extend(true,{},k.__batchResponses[0]);if(l.hasOwnProperty("data")&&l.statusCode>="200"&&l.statusCode<"300"){var m=l.data;var n={};for(i=1;i<k.__batchResponses.length;i++){if(k.__batchResponses[i].hasOwnProperty("data")&&k.__batchResponses[i].statusCode>='200'&&k.__batchResponses[i].statusCode<'300'){var R=k.__batchResponses[i].data;switch(true){case(r[i].indexOf("DecisionOptions")!==-1):f.oDecisionOptions[o+T]=R.results;break;case(r[i].indexOf("CustomAttributeDefinitionData")!==-1):f.oCustomAttributeDefinitions[T]=R.results;break;case(r[i].indexOf("Comments/$count")!==-1):n.sCommentsCount=R;break;case(r[i].indexOf("Attachments/$count")!==-1):n.sAttachmentsCount=R;break;case(r[i].indexOf("TaskObjects/$count")!==-1):n.sTaskObjectsCount=R;break;default:}}}s(m,f.oCustomAttributeDefinitions[T],n,f.oDecisionOptions[o+T]);}else{f._refreshListOnError(o,I);}}}.bind(null,r);var j=function(k){var v={};v.bValue=false;f.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","showReleaseLoaderOnInfoTab",v);f.oDataRequestFailed(k);};var v={};v.bValue=true;f.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","showReleaseLoaderOnInfoTab",v);f.setDetailPageLoaded(false);f.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"GET",sBatchGroupId:"DetailWithDecisionOptions",numberOfRequests:r.length,fnSuccessCallback:h,fnErrorCallback:j});},readCustomAttributeDefinitionData:function(o,t,s){var c=this;var d="/"+c.sTaskDefinitionCollectionName+"(SAP__Origin='"+a(o)+"',TaskDefinitionID='"+a(t)+"')";var e={$expand:c.sCustomAttributeDefinitionNavProperty};var f=function(h,r){s(h);};var g=function(h){c.oDataRequestFailed(h);};this.oDataRead(d,e,f,g);},readReasonOptions:function(o,i,d,c,e){this.oDataRead("/"+this.FUNCTION_IMPORT_REASONOPTIONS,{SAP__Origin:"'"+o+"'",InstanceID:"'"+i+"'",DecisionKey:"'"+d+"'"},function(f){if(f&&f.results){if(c){c(f.results);}}},function(f){this.oDataRequestFailed(f);if(e){e(f);}}.bind(this),"reasonOptions");},readDecisionOptions:function(o,i,t,c,d,h,g){var e=this;if(h){e.fnShowReleaseLoader(true);}if(!g){g="decisionOptions";}this.oDataRead("/"+this.FUNCTION_IMPORT_DECISIONOPTIONS,{SAP__Origin:"'"+o+"'",InstanceID:"'"+i+"'"},function(f,r){if(h){e.fnShowReleaseLoader(false);}if(f&&f.results){e.oDecisionOptions[o+t]=f.results;if(c){c(f.results);}}},function(f){if(h){e.fnShowReleaseLoader(false);}e.oDataRequestFailed(f);if(d){d(f);}},g);},_doReadDetail:function(c,e,I,s,f){var d;var i=-1;if(!I){i=e.indexOf("Comments/CreatedByDetails");}if(i>=0){e[i]="Comments";}d={$expand:e.join(",")};this.oDataRead(c,d,s,f);},readPotentialOwners:function(o,i,s,e){var t=this;t.fnShowLoaderInDialogs(true);this.oDataRead("/TaskCollection(SAP__Origin='"+a(o)+"',InstanceID='"+a(i)+"')/PotentialOwners",null,function(d,r){t.fnShowLoaderInDialogs(false);if(d){if(s){s(d);}}},function(c){t.fnShowLoaderInDialogs(false);t.oDataRequestFailed(c);if(e){e(c);}});},readDescription:function(o,i,s,e){var t=this;if(t.oDescriptions[o+i]){if(s){s(t.oDescriptions[o+i]);}return;}t.oDataRead("/TaskCollection(SAP__Origin='"+a(o)+"',InstanceID='"+a(i)+"')/Description",null,function(d,r){if(d){t.oDescriptions[o+i]=d;if(s){s(d);}}},function(c){t.oDataRequestFailed(c);if(e){e(c);}});},readUserInfo:function(s,u,f,e,c){var t=this;if(!c){t.fnShowReleaseLoader(true);}this.oDataRead("/UserInfoCollection(SAP__Origin='"+a(s)+"',UniqueName='"+a(u)+"')",null,function(d,r){if(!c){t.fnShowReleaseLoader(false);}if(d){f(d);}},function(o){if(!c){t.fnShowReleaseLoader(false);}t.oDataRequestFailed(o);if(e){e(o);}});},_processFilterOptionsResult:function(d){this.oPriorityMap={};this.oStatusMap={};var n;q.each(d.results,function(i,e){if(e.Type==="PRIORITY"){if(!this.oPriorityMap.hasOwnProperty(e.SAP__Origin)){this.oPriorityMap[e.SAP__Origin]={};}n=this.oPriorityMap[e.SAP__Origin];n[e.TechnicalName]=e.DisplayName;}else if(e.Type==="STATUS"){if(!this.oStatusMap.hasOwnProperty(e.SAP__Origin)){this.oStatusMap[e.SAP__Origin]={};}n=this.oStatusMap[e.SAP__Origin];n[e.TechnicalName]=e.DisplayName;}}.bind(this));},getPriorityDisplayName:function(o,t){var n;if(o==null||t==null){throw"sOrigin and sTechnicalName mustn't be null";}if(this.oPriorityMap&&this.oPriorityMap.hasOwnProperty(o)){n=this.oPriorityMap[o];if(n.hasOwnProperty(t)){return n[t];}}return null;},getStatusDisplayName:function(o,t){var n;if(o==null||t==null){throw"sOrigin and sTechnicalName mustn't be null";}if(this.oStatusMap&&this.oStatusMap.hasOwnProperty(o)){n=this.oStatusMap[o];if(n.hasOwnProperty(t)){return n[t];}}return null;},getErrorMessageKey:function(f){switch(f){case this.sReleaseAction:return"dialog.error.release";case this.sClaimAction:return"dialog.error.claim";case this.sResumeAction:return"dialog.error.resume";default:return"dialog.error.generic.action";}},sendAction:function(f,d,n,r,s,e){this.fnShowReleaseLoader(true);var c=this.oi18nResourceBundle.getText(this.getErrorMessageKey(f));var u={SAP__Origin:"'"+encodeURIComponent(d.SAP__Origin)+"'",InstanceID:"'"+(d.InstanceID)+"'"};if(d.DecisionKey){u.DecisionKey="'"+d.DecisionKey+"'";}if(n&&n.length>0){u.Comments="'"+n+"'";}if(r){u.ReasonCode="'"+r+"'";}this._performPost("/"+f,d.SAP__Origin,u,function(d,s){this.fnShowReleaseLoader(false);this.processListAfterAction(d.SAP__Origin,d.InstanceID);this.triggerRefresh("SENDACTION",this.ACTION_SUCCESS);this.fireActionPerformed();if(s){s();}}.bind(this,d,s),function(o){this.fnShowReleaseLoader(false);if(e){e(o);}this.processListAfterAction(d.SAP__Origin,d.InstanceID);this.fireActionPerformed();this.triggerRefresh("SENDACTION",this.ACTION_FAILURE);}.bind(this),c);},triggerRefresh:function(A,s){var m={},i,I=D.system.phone;i=this.getTableView()&&(!I||this.getTableViewOnPhone());m.bIsTableViewActive=i;m.sAction=A;m.sStatus=s;if(i||I||this.bStandaloneDetailDeep){this.fireRefreshDetails(m);}},doForward:function(o,i,u,n,s,e){var c={SAP__Origin:"'"+o+"'",InstanceID:"'"+i+"'",ForwardTo:"'"+u+"'",Comments:"'"+n+"'"};this.fnShowReleaseLoader(true);this._performPost("/Forward",o,c,function(d,r){this.fnShowReleaseLoader(false);this.processListAfterAction(o,i);this.triggerRefresh("FORWARD",this.ACTION_SUCCESS);this.fireActionPerformed();s();}.bind(this),function(){this.fnShowReleaseLoader(false);this.processListAfterAction(o,i);this.triggerRefresh("FORWARD",this.ACTION_FAILURE);this.fireActionPerformed();if(e){e();}}.bind(this),this.oi18nResourceBundle.getText("dialog.error.forward"));},doResubmit:function(o,i,r,s,e){var u="SAP__Origin="+"'"+o+"'"+"&InstanceID="+"'"+i+"'"+"&ResubmissionDate="+r;this.fnShowReleaseLoader(true);this._performPost("/"+this.FUNCTION_IMPORT_RESUBMIT,o,u,function(){this.fnShowReleaseLoader(false);this.processListAfterAction(o,i);this.triggerRefresh("RESUBMIT",this.ACTION_SUCCESS);this.fireActionPerformed();s();}.bind(this),function(){this.fnShowReleaseLoader(false);this.processListAfterAction(o,i);this.triggerRefresh("RESUBMIT",this.ACTION_FAILURE);this.fireActionPerformed();if(e){e();}}.bind(this),this.oi18nResourceBundle.getText("dialog.error.resubmit"));},doMassClaimRelease:function(I,A,s,e){var t=this;var r=[];var p=[];for(var i=0;i<I.length;i++){var o=I[i].getBindingContext().getObject();r.push("/"+A);var P="SAP__Origin='"+a(o.SAP__Origin)+"'&InstanceID='"+a(o.InstanceID)+"'";p.push(P);}var f=function(d){t.fireActionPerformed();t.fnShowReleaseLoader(false);var g=d.__batchResponses;var h=[];var j=[];for(var i=0;i<g.length;i++){var k=g[i];var o=I[i].getBindingContext().getObject();var l=false;if(k.hasOwnProperty("__changeResponses")){var m=k.__changeResponses[0];if(m.statusCode>="200"&&m.statusCode<"300"){l=true;}}if(l){o.message=t.oi18nResourceBundle.getText("multi.processed");h.push(o);}else if(k.response){o.message=JSON.parse(k.response.body).error.message.value;j.push(o);}}if(s){s(h,j);}};var c=function(d){t.fireActionPerformed();t.fnShowReleaseLoader(false);t.oDataRequestFailed(d);if(e){e(d);}};t.fnShowReleaseLoader(true);t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"massClaimRelease",numberOfRequests:r.length,fnSuccessCallback:f,fnErrorCallback:c});},doMassForward:function(I,A,n,s,e){var r=[];var p=[];var t=this;for(var i=0;i<I.length;i++){var o=I[i];var P="/Forward";var c="SAP__Origin='"+a(o.SAP__Origin)+"'&InstanceID='"+a(o.InstanceID)+"'&ForwardTo='"+a(A.UniqueName)+"'";if(n&&n.length>0){c+="&Comments='"+a(n)+"'";}r.push(P);p.push(c);}var f=function(g){t.fireActionPerformed();t.fnShowReleaseLoader(false);var h=g.__batchResponses;var j=[];var k=[];for(var i=0;i<h.length;i++){var l=h[i];var o=I[i];var m=false;if(l.hasOwnProperty("__changeResponses")){var u=l.__changeResponses[0];if(u.statusCode>="200"&&u.statusCode<"300"){m=true;}}if(m){o.message=t.oi18nResourceBundle.getText("multi.processed");j.push(o);}else if(l.response){o.message=JSON.parse(l.response.body).error.message.value;k.push(o);}}if(s){s(j,k,A);}};var d=function(g){t.fireActionPerformed();t.fnShowReleaseLoader(false);t.oDataRequestFailed(g);if(e){e(g);}};t.fnShowReleaseLoader(true);t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"massForward",numberOfRequests:r.length,fnSuccessCallback:f,fnErrorCallback:d});},doMassResubmit:function(I,r,s,e,h){var R=[];var p=[];var t=this;var c=[];for(var i=0;i<I.length;i++){var o=I[i];var P="/"+this.FUNCTION_IMPORT_RESUBMIT;var d="SAP__Origin='"+a(o.SAP__Origin)+"'&InstanceID='"+a(o.InstanceID)+"'&ResubmissionDate="+r;R.push(P);p.push(d);}var f=function(j){t.fireActionPerformed();if(h){t.fnShowReleaseLoader(false);}var k=j.__batchResponses;var l=[];var m=[];for(var i=0;i<k.length;i++){var n=k[i];var o=I[i];var u=false;if(n.hasOwnProperty("__changeResponses")){var v=n.__changeResponses[0];if(v.statusCode>="200"&&v.statusCode<"300"){u=true;c.push({index:i,oData:v.data});}}if(u){o.message=t.oi18nResourceBundle.getText("multi.processed");l.push(o);}else if(n.response){o.message=JSON.parse(n.response.body).error.message.value;m.push(o);}}if(s){s(l,m,c);}};var g=function(j){t.fireActionPerformed();if(h){t.fnShowReleaseLoader(false);}t.oDataRequestFailed(j);if(e){e(j);}};t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:R,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"massResubmit",numberOfRequests:R.length,fnSuccessCallback:f,fnErrorCallback:g});},searchUsers:function(o,s,m,f){this.fnShowLoaderInDialogs(true);var t=this;var p={SAP__Origin:"'"+o+"'",SearchPattern:"'"+s+"'",MaxResults:m};this.oDataRead("/SearchUsers",p,function(d,r){t.fnShowLoaderInDialogs(false);if(d&&d.results){if(f){f(d.results);}}},function(e){t.fnShowLoaderInDialogs(false);t.oDataRequestFailed(e);});},_performPost:function(p,o,u,s,e,c){this.oDataCreate(p,o,u,undefined,undefined,function(d,r){L.info("successful action");if(s){(s.bind(this))(d,r);}}.bind(this),function(d){var f;var P;if(d&&d.statusCode=="429"&&d.responseText){var g=JSON.parse(d.responseText);if(g.error&&g.error.code==="bpm.workflowruntime.rate.limit.exceeded"){P={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.rateLimitError"),details:d.responseText}};}}else if(d&&d.statusCode=="509"&&d.responseText){P={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.rateLimitError"),details:d.responseText}};}else if(c){f=this.getErrorMessage(d);P={customMessage:{message:c,details:f}};}else{f=this.getErrorMessage(d);P={customMessage:{message:d.message,details:f}};}this.oDataRequestFailed(P,e);}.bind(this));},oDataRequestFailed:function(e,f){var m;var d;var p;if(e.hasOwnProperty("customMessage")){m=e.customMessage.message;d=e.customMessage.details;}else{if(e.response&&e.response.statusCode=="0"){m=this.oi18nResourceBundle.getText("DataManager.connectionError");}else{m=this.oi18nResourceBundle.getText("DataManager.HTTPRequestFailed");}if(e.response&&e.response.body!=""&&e.response.statusCode=="400"){p=JSON.parse(e.response.body);d=p.error.message.value;}else{d=e.response?e.response.body:null;}}var P;if(e.oEvent&&e.oEvent.getParameter("response")){P=e.oEvent.getParameter("response");}else{P=e;}if(P&&P.responseText){if(P.statusCode=="429"){p=JSON.parse(P.responseText);if(p.error&&p.error.code==="bpm.workflowruntime.rate.limit.exceeded"){m=this.oi18nResourceBundle.getText("DataManager.rateLimitError");d=P.responseText;}}if(P.statusCode=="509"){m=this.oi18nResourceBundle.getText("DataManager.rateLimitError");d=P.responseText;}}var o={message:m,responseText:d};this.showLocalErrorMessage(o,f);this.oModel.fireRequestFailed(o);},oDataRead:function(p,u,s,e,g){this.oModel.read(p,{urlParameters:u,success:s,error:e,groupId:g});},oDataCreate:function(p,o,u,d,c,s,e){var f={context:c,success:s,error:e,urlParameters:u};this.oModel.create(p,d,f);},oDataAddOperationsAndSubmitBatch:function(r,c,s,e,A){this.oPostActionModel.clearBatch();if(r){this.oPostActionModel.addBatchReadOperations(r);}if(c){for(var i=0;i<c.length;i++){this.oPostActionModel.addBatchChangeOperations([c[i]]);}}this.oPostActionModel.submitBatch(s,e,A);},oDataConvertHeaders:function(c,h){for(var H in h){if(H!==c&&H.toLowerCase()===c.toLowerCase()){var o=h[H];delete h[H];h[c]=o;break;}}},addComment:function(s,i,c,f,e){var u={SAP__Origin:"'"+s+"'",InstanceID:"'"+i+"'",Text:"'"+c+"'"};this._performPost("/AddComment",s,u,function(d,r){if(f){f(d,r);}}.bind(this),function(o){if(e){e(o);}}.bind(this),this.oi18nResourceBundle.getText("dialog.error.addComment"));},_createSubstitutionRule:function(A,p,s,e){var r=[];var P=[];var c=[];var t=this;q.each(p,function(i,g){var T={};T=q.extend(true,{},A);T.SAP__Origin=g;r.push("/SubstitutionRuleCollection");P.push("");c.push(T);});var f=function(o){t.fnShowReleaseLoader(false);var g=o.__batchResponses;var h=[];var i=[];q.each(g,function(k,l){var m=false;if(l.hasOwnProperty("__changeResponses")){var n=l.__changeResponses[0];if(n.statusCode>="200"&&n.statusCode<"300"){m=true;}}if(m){h.push(k);}else{i.push(l);}});if(i.length>0){var j=h.length>0?t.oi18nResourceBundle.getText("substn.create.multi.error"):t.oi18nResourceBundle.getText("substn.create.error");t._handleBatchErrors(i,j);}if(s){s(h,i);}t.fnShowReleaseLoader(false);};var d=function(o){t.fnShowReleaseLoader(false);t.oDataRequestFailed(o);if(e){e(o);}};t.fnShowReleaseLoader(true);t.fireBatch({aPaths:r,aUrlParameters:P,sMethod:"POST",sBatchGroupId:"CreateSubstitutionRule",numberOfRequests:r.length,fnSuccessCallback:f,fnErrorCallback:d,aProperties:c});},showLocalErrorMessage:function(e,f){var o=sap.ui.core.Element.registry.filter(function(c){var i=c.isA("sap.m.Dialog")&&c.getType()==="Message"&&c.isOpen();if(!i){return false;}var d=c.getContent();if(!d||d.length===0||!d[0].getItems){return false;}var I=d[0].getItems();if(!I||I.length===0||!I[0].isA("sap.m.Text")){return false;}return I[0].getText()===e.message;});if(o.length>0){if(f){f();}return;}M.error(e.message,{details:C.fnRemoveHtmlTags(e.responseText),onClose:f});},readSubstitutionData:function(s){var t=this;var r=[];var p=[];var c=new cross.fnd.fiori.inbox.Configuration();var i=c.getServiceList()[0].serviceUrl==="/bpmodata/tasks.svc/";r.push("/SubstitutionRuleCollection");p.push("");if(this.checkEntitySetExistsInMetadata("SystemInfoCollection")&&!this.aSystemInfoCollection&&!i){r.push("/SystemInfoCollection");p.push("");}if(this.checkEntitySetExistsInMetadata("SubstitutionProfileCollection")&&!this.aSubstitutionProfilesCollection){r.push("/SubstitutionProfileCollection");p.push("");}var f=function(d){if(d.hasOwnProperty("__batchResponses")&&d.__batchResponses.length>=1){var g=[];var o=null;if(d.__batchResponses.length===3){o=d.__batchResponses[2];if(!(g.length>0)&&o.hasOwnProperty("data")&&o.statusCode>="200"&&o.statusCode<"300"){t.aSubstitutionProfilesCollection=o.data.results;}else if(o.hasOwnProperty("response")&&o.response.statusCode>="400"){g.push(JSON.parse(o.response.body));}var h=d.__batchResponses[1];if(!(g.length>0)&&h.hasOwnProperty("data")&&h.statusCode>="200"&&h.statusCode<"300"){t.aSystemInfoCollection=h.data.results;}else if(h.hasOwnProperty("response")&&h.response.statusCode>="400"){g.push(JSON.parse(h.response.body));}}else if(d.__batchResponses.length===2&&i){o=d.__batchResponses[1];if(!(g.length>0)&&o.hasOwnProperty("data")&&o.statusCode>="200"&&o.statusCode<"300"){t.aSubstitutionProfilesCollection=o.data.results;}else if(o.hasOwnProperty("response")&&o.response.statusCode>="400"){g.push(JSON.parse(o.response.body));}t.aSystemInfoCollection=[{SAP__Origin:"NA",SystemAlias:"NA",SystemType:"BPM"}];}var j=d.__batchResponses[0];if(!(g.length>0)&&j.hasOwnProperty("data")&&j.statusCode>="200"&&j.statusCode<"300"){s(j.data,t.aSubstitutionProfilesCollection,t.aSystemInfoCollection);}else if(j.hasOwnProperty("response")&&j.response.statusCode>="400"){g.push(JSON.parse(j.response.body));}t.fnShowReleaseLoader(false);t._handleBatchErrors(g);}};var e=function(o){t.fnShowReleaseLoader(false);t.oDataRequestFailed(o);};t.fnShowReleaseLoader(true);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"GET",sBatchGroupId:"SubstitutionData",numberOfRequests:r.length,fnSuccessCallback:f,fnErrorCallback:e});},updateSubstitutionRule:function(A,e,s,f){var r=[];var p=[];var t=this;var u=S.formatterSubstitutedUserName(A.User,A.FullName);var R=e?A.aDisabledRules:A.aEnabledRules;for(var i=0;i<R.length;i++){var I=R[i];var P="/"+t.FUNCTION_IMPORT_ENABLESUBSTITUTIONRULE;var o={SubstitutionRuleID:"'"+I.subRuleId+"'",SAP__Origin:"'"+I.sOrigin+"'",Enabled:e};r.push(P);p.push(o);}var c=function(g){var h=[];var j=[];var k=g.__batchResponses;var m;q.each(k,function(l,n){var v=false;if(n.hasOwnProperty("__changeResponses")){var w=n.__changeResponses[0];if(w.statusCode>="200"&&w.statusCode<"300"){j.push(l);v=true;}}if(!v){h.push(n);}});if(j.length>0&&h.length===0){setTimeout(function(){m=e?t.oi18nResourceBundle.getText("addInbox.enable.rule.success",u):t.oi18nResourceBundle.getText("addInbox.disable.rule.success",u);b.show(m);},500);}else if(j.length===0){m=t.oi18nResourceBundle.getText("addInbox.action.error");}else{m=e?t.oi18nResourceBundle.getText("addInbox.enable.rule.partial.success",u):t.oi18nResourceBundle.getText("addInbox.disable.rule.partial.success",u);}t._handleBatchErrors(h,m);if(s){s(j.length);}};var d=function(g){var h={customMessage:{message:t.oi18nResourceBundle.getText("addInbox.action.error"),details:t.getErrorMessage(oError)}};t.oDataRequestFailed(h);if(f){f();}};t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"updateSubstitution",numberOfRequests:r.length,fnSuccessCallback:c,fnErrorCallback:d});},deleteAttachment:function(s,i,A,f,e){var p="/AttachmentCollection(SAP__Origin='"+a(s)+"',InstanceID='"+a(i)+"',ID='"+a(A)+"')/$value";var r=[];r.push(p);var c=function(o){if(o.__batchResponses&&o.__batchResponses[0]&&o.__batchResponses[0].response){var g=o.__batchResponses[0].response;if(g.statusCode){if(g.statusCode>="200"&&g.statusCode<"300"){f();}else{e();}}}else{f();}};var d=function(){e();};this.fireBatch({aPaths:r,aUrlParameters:"",sMethod:"DELETE",sBatchGroupId:"DeleteAttachment",numberOfRequests:r.length,fnSuccessCallback:c,fnErrorCallback:d});},deleteSubstitution:function(r,s){var t=this;this.fnShowReleaseLoader(true);if(r.length===1){var u={SubstitutionRuleID:"'"+r[0].SubstitutionRuleId+"'",SAP__Origin:"'"+r[0].SAP__Origin+"'"};var e=function(){t.fnShowReleaseLoader(false);};var f=function(d){t.fnShowReleaseLoader(false);s(d);};this._performPost("/DeleteSubstitutionRule",r[0].SAP__Origin,u,f,e,this.oi18nResourceBundle.getText("substn.delete.error"));}else if(r.length>1){var R=[];var p=[];q.each(r,function(i,o){var d=this.getDeleteSubtnEntry(o);R.push(d.rule);p.push(d.parameters);}.bind(this));var f=function(d){t.fnShowReleaseLoader(false);var g=d.__batchResponses;var h=[];var i=[];q.each(g,function(k,o){var l=false;if(o.hasOwnProperty("__changeResponses")){var m=o.__changeResponses[0];if(m.statusCode>="200"&&m.statusCode<"300"){h.push(k);l=true;}}if(!l){i.push(o);}});if(h.length>0){s(h,i);}if(i.length>0){var j=h.length>0?this.oi18nResourceBundle.getText("substn.delete.multi.error"):this.oi18nResourceBundle.getText("substn.delete.error");this._handleBatchErrors(i,j);}};var c=function(o){t.fnShowReleaseLoader(false);var d=this.getErrorMessage(o);var o={customMessage:{message:this.oi18nResourceBundle.getText("substn.delete.error"),details:d}};this.oDataRequestFailed(o);};t.fireBatch({aPaths:R,aUrlParameters:p,sMethod:"FUNCTIONIMPORT",sBatchGroupId:"DeleteSubstitution",numberOfRequests:R.length,fnSuccessCallback:f,fnErrorCallback:c});}},getDeleteSubtnEntry:function(r){return{rule:"/DeleteSubstitutionRule",parameters:{SubstitutionRuleID:r.SubstitutionRuleId,SAP__Origin:r.SAP__Origin}};},getErrorMessage:function(o){if(o.response&&o.response.body&&o.response.body!=""){try{var m=JSON.parse(o.response.body);return(m.error.message.value?m.error.message.value:null);}catch(e){return o.response.body;}}else if(o.responseText&&o.responseText!=""){try{var m=JSON.parse(o.responseText);return m.error.message.value?m.error.message.value:null;}catch(e){return o.responseText;}}else if(o instanceof Event&&(o.getParameter("responseText")||o.getParameter("response").body)){return o.getParameter("responseText")?o.getParameter("responseText"):o.getParameter("response").body;}else{return null;}},readSubstitutionProfiles:function(o,c){if(this.aSubstitutionProfilesCollection){if(o){o(this.aSubstitutionProfilesCollection);}return;}var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/SubstitutionProfileCollection",null,function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){if(o){o(d.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(c){c(e);}});},readSystemInfoCollection:function(o,c){if(this.aSystemInfoCollection){if(o){o(this.aSystemInfoCollection);}return;}var d=new cross.fnd.fiori.inbox.Configuration();var i=d.getServiceList()[0].serviceUrl==="/bpmodata/tasks.svc/";var s=this.checkEntitySetExistsInMetadata("SystemInfoCollection");if(i||!s){this.aSystemInfoCollection=[{SAP__Origin:"NA",SystemAlias:"NA",SystemType:"NA"}];if(o){o(this.aSystemInfoCollection);}return;}var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/SystemInfoCollection",null,function(e,r){t.fnShowReleaseLoader(false);if(e&&e.results){t.aSystemInfoCollection=e.results;if(o){o(e.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(c){c(e);}});},readTaskDefinitionCollection:function(o,c,m){var t=this;this.oDataRead("/TaskDefinitionCollection",null,function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){if(o){o(d.results,m);}}},function(e){t.oDataRequestFailed(e);if(c){c([]);}});},fnGetCount:function(o,i,s,e,g){var t=this;var c=this._getTaskContextPath(o,i)+"/"+e+"/$count";var f=function(d){t.oDataRequestFailed(d);};this.oDataRead(c,null,function(d){s(d);},f,g);},_getTaskContextPath:function(o,i){return"/"+"TaskCollection"+"(SAP__Origin='"+a(o)+"',InstanceID='"+a(i)+"')";},fnIsImagePresent:function(u){var i=false;q.ajax({url:u,type:"GET",contentType:"image/jpeg",async:false,success:function(d,s,j){if(d!=""&&d!=undefined){i=true;}},error:function(d,t,c){i=false;}});return i;},fnShowReleaseLoader:function(v){var V={};V["bValue"]=v;this.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","showReleaseLoader",V);},fnShowLoaderInDialogs:function(v){var V={};V["bValue"]=v;cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().publish("cross.fnd.fiori.inbox.dataManager","showLoaderInDialogs",V);},_refreshListOnError:function(o,i){var t=this;this.oModel.bFullRefreshNeeded=true;setTimeout(function(){b.show(t.oi18nResourceBundle.getText("dialog.info.task_completed"));},500);if(D.system.phone){this.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","refreshOnError");}else{this.processListAfterAction(o,i);}this.oModel.refresh();},checkStatusAndOpenTask:function(o,i,O){var t=this;var e=function(){t._refreshListOnError(o,i);};var s=function(d){if(d.hasOwnProperty("__batchResponses")&&d.__batchResponses.length>0){var c=d.__batchResponses[0];if(c.hasOwnProperty("data")&&c.statusCode>="200"&&c.statusCode<"300"){if(!(c.data.Status===t.sStatusCompleted)&&(t.bOutbox==false)){O();return;}else if(t.bOutbox==true){O();return;}}}e();};this.fireBatch({aPaths:[this._getTaskContextPath(o,i)],aUrlParameters:[{$select:"Status"}],sMethod:"GET",sBatchGroupId:"GetLatestStatus",numberOfRequests:1,fnSuccessCallback:s,fnErrorCallback:e});},readAddInboxUsers:function(s,e){var t=this;this.oDataRead("/SubstitutesRuleCollection",null,function(d,r){if(d){if(s){s(d);}}},function(o){e();t.fnShowReleaseLoader(false);var d=t.getErrorMessage(o);var o={customMessage:{message:t.oi18nResourceBundle.getText("addInbox.read.error"),details:d}};t.oDataRequestFailed(o);});},readSubstitutedUserList:function(s,e){var t=this;this.oDataRead("/SubstitutedUsersCollection",null,function(d,r){if(d&&s){s(d);}},function(o){e();t.fnShowReleaseLoader(false);var d=t.getErrorMessage(o);var o={customMessage:{message:t.oi18nResourceBundle.getText("substitutesUser.read.error"),details:d}};t.oDataRequestFailed(o);});},refreshListOnAddInboxDone:function(e){if(cross.fnd.fiori.inbox.util.tools.Application.getImpl().oCurController.MasterCtrl){this.readTaskDefinitionCollection(q.proxy(this.updateTaskDefinitionModel),null,false);this.oModel.bFullRefreshNeeded=true;this.oModel.refresh();}else{cross.fnd.fiori.inbox.util.tools.Application.getImpl().getComponent().getEventBus().publish("cross.fnd.fiori.inbox","refreshListInternal");}},updateTaskDefinitionModel:function(r,m){var c=cross.fnd.fiori.inbox.util.tools.Application.getImpl().oCurController.MasterCtrl;c.getView().getModel("taskDefinitionsModel").setData(r,m);},handleMetadataFailed:function(e){var d=this.getErrorMessage(e);var e={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.metadataFailed"),details:d}};this.oDataRequestFailed(e);},checkImageAvailabilityAsync:function(u,s,e){q.ajax({url:u,type:"GET",contentType:"image/jpeg",async:true,success:function(d,c,j){if(d!=""&&d!=undefined){s();}else{e();}},error:function(d,t,c){e();}});},fetchUIExecutionLink:function(i,s,e){var t=this;if(!i.TaskSupports.UIExecutionLink){e({});return;}if(!this.isUIExecnLinkNavProp()&&i.GUI_Link){var u={GUI_Link:i.GUI_Link};this.oUIExecutionLinks[i.SAP__Origin+i.InstanceID]=u;s(u);return;}if(this.oUIExecutionLinks[i.SAP__Origin+i.InstanceID]){s(this.oUIExecutionLinks[i.SAP__Origin+i.InstanceID]);return;}this.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","UIExecutionLinkRequest",{bValue:true});this.oDataRead(this._getTaskContextPath(i.SAP__Origin,i.InstanceID)+"/UIExecutionLink",null,function(d){t.oUIExecutionLinks[i.SAP__Origin+i.InstanceID]=d;s(d);t.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","UIExecutionLinkRequest",{bValue:false});},function(c){L.error(c);e({});t.oEventBus.publish("cross.fnd.fiori.inbox.dataManager","UIExecutionLinkRequest",{bValue:false});},"UILink");},isUIExecnLinkNavProp:function(){if(this.oServiceMetaModel&&this.bUIExecnLinkNavProp===undefined){this.bUIExecnLinkasNavProp=!this.checkPropertyExistsInMetadata("GUI_Link");}return this.bUIExecnLinkasNavProp;},getDataFromCache:function(k,i){return this.oCacheStore[k][this.getCacheStoreKey(k,i)];},getCacheStoreKey:function(k,i){switch(k){case"UIExecutionLink":return i.SAP__Origin+i.InstanceID;case"DecisionOptions":return i.SAP__Origin+i.TaskDefinitionID;case"Descriptions":return i.SAP__Origin+i.InstanceID;default:}},getCurrentUserImage:function(o,u,s){var i=this.oModel.sServiceUrl+"/UserInfoCollection(SAP__Origin='"+o+"',UniqueName='"+u+"')/$value";if(this.oCurrentUserImageAvailability[i]!=null&&this.oCurrentUserImageAvailability[i]===true){s(i);return;}var t=this;q.ajax({url:i,type:"GET",contentType:"image/jpeg",async:true,success:function(d,c,j){if(d!=""&&d!=undefined){t.oCurrentUserImageAvailability[i]=true;s(i);}else{t.oCurrentUserImageAvailability[i]=false;}}});},getCustomAttributeDefinitions:function(){return this.oCustomAttributeDefinitions;},getShowAdditionalAttributes:function(){return this.bShowAdditionalAttributes;},getDetailPageLoaded:function(){return this.bDetailPageLoaded;},setDetailPageLoaded:function(v){this.bDetailPageLoaded=v;},getDetailPageLoadedViaDeepLinking:function(){return this.bDetailPageLoadedViaDeepLinking;},setDetailPageLoadedViaDeepLinking:function(v){this.bDetailPageLoadedViaDeepLinking=v;},setCallFromDeepLinkURL:function(v){this.bIsDeepLinkingURLCall=v;},getCallFromDeepLinkURL:function(){return this.bIsDeepLinkingURLCall;},_getURLParametersfromStartUpParameters:function(s){var u=U.fromURL(window.location.href);if(s){if(s.fullWidth&&s.fullWidth.length>0){this.bFullWidth=s.fullWidth[0]=="true"?true:false;}else{this.bFullWidth=u.get("fullWidth")=="true"?true:false;}if(s.substitution&&s.substitution.length>0){this.bSubstitution=s.substitution[0]=="true"?true:false;}else{this.bSubstitution=u.get("substitution")=="false"?false:true;}if(s.showLog&&s.showLog.length>0){this.bShowLog=s.showLog[0];}else{this.bShowLog=u.get("showLog")=="false"?false:true;}if(s.taskTitleInHeader&&s.taskTitleInHeader.length>0){this.bTaskTitleInHeader=s.taskTitleInHeader[0]=="true"?true:false;}else{this.bTaskTitleInHeader=u.get("taskTitleInHeader")=="true"?true:false;}if(s.standaloneDetailDeep&&s.standaloneDetailDeep.length>0){this.bStandaloneDetailDeep=s.standaloneDetailDeep[0]=="true"?true:false;}else{this.bStandaloneDetailDeep=u.get("standaloneDetailDeep")=="true"?true:false;}if(s.expertMode&&s.expertMode.length>0){this.tableView=(s.expertMode[0]=="true"||s.expertMode[0]==true)?true:false;}else{this.tableView=u.get("expertMode")=="true"?true:false;}if(s.expertModeOnPhone&&s.expertModeOnPhone.length>0){this.tableViewOnPhone=s.expertModeOnPhone[0];}else{this.tableViewOnPhone=u.get("expertModeOnPhone")=="true"?true:false;}if(s.scenarioId&&s.scenarioId.length>0){this.sScenarioId=s.scenarioId[0];}else{this.sScenarioId=u.get("scenarioId");}if(!this.sScenarioId){if(s.taskDefinitions&&s.taskDefinitions[0]){this.sClientScenario=decodeURIComponent(s.taskDefinitions[0]);}else{var t=u.get("taskDefinitions");if(t!=null){this.sClientScenario=decodeURIComponent(t);}}}if(s.userSearch&&s.userSearch.length>0){this.userSearch=s.userSearch[0]=="false"?false:true;}else{this.userSearch=u.get("userSearch")=="false"?false:true;}if(s.allItems&&s.allItems.length>0){this.bAllItems=(s.allItems[0]=="true"||s.allItems[0]==true)?true:false;}else{this.bAllItems=u.get("allItems")=="true"?true:!(this.sScenarioId||this.sClientScenario);}this.bAllItems=this.bAllItems||!(this.sScenarioId||this.sClientScenario);if(s.outbox&&s.outbox.length>0){this.bOutbox=s.outbox[0]=="true"?true:false;}else{this.bOutbox=u.get("outbox")=="true"?true:false;}if(s.showAdditionalAttributes&&s.showAdditionalAttributes.length>0){this.bShowAdditionalAttributes=(s.showAdditionalAttributes[0]=="true"||s.showAdditionalAttributes[0]==true)?true:false;}else{this.bShowAdditionalAttributes=u.get("showAdditionalAttributes")=="true"?true:false;}if(s.massAction&&s.massAction.length>0){if(s.massAction[0]=="true"){this.bIsMassActionEnabled=true;}else if(s.massAction[0]=="false"){this.bIsMassActionEnabled=false;}}else if(u.get("massAction")=="true"){this.bIsMassActionEnabled=true;}else if(u.get("massAction")=="false"){this.bIsMassActionEnabled=false;}if(s.quickAction&&s.quickAction.length>0){if(s.quickAction[0]=="true"){this.bIsQuickActionEnabled=true;}else if(s.quickAction[0]=="false"){this.bIsQuickActionEnabled=false;}}else if(u.get("quickAction")=="true"){this.bIsQuickActionEnabled=true;}else if(u.get("quickAction")=="false"){this.bIsQuickActionEnabled=false;}if(s.sortBy&&s.sortBy.length>0){this.sDefaultSortBy=s.sortBy[0];}else{this.sDefaultSortBy=u.get("sortBy");}var l;if(s.listSize&&s.listSize.length>0){l=s.listSize[0];}else{l=u.get("listSize");}if(l&&q.isNumeric(l)&&parseInt(l,10)>0){this.iListSize=parseInt(l,10);}var T=u.get("taskObjects");if(s.taskObjects&&s.taskObjects.length>0){this.bShowTaskObjects=s.taskObjects[0]=="true"?true:false;}else if(T&&T.length>0){this.bShowTaskObjects=T==="true"?true:false;}else{this.bShowTaskObjects=D.system.desktop;}var p;if(s.pageSize&&s.pageSize.length>0){p=s.pageSize[0];}else{p=u.get("pageSize");}if(p&&q.isNumeric(p)&&parseInt(p,10)>0){this.iPageSize=parseInt(p,10);}if(s.enablePaging&&s.enablePaging.length>0){this.bEnablePaging=s.enablePaging[0]==="true"?true:false;}else{this.bEnablePaging=u.get("enablePaging")==="true"?true:false;}var o;if(s.operationMode&&s.operationMode.length>0){o=s.operationMode[0];}else{o=u.get("operationMode");}if(o&&o.toUpperCase()==="CLIENT"){this.sOperationMode="Client";}else{this.sOperationMode="Server";}var c;if(s.cacheSize&&s.cacheSize.length>0){c=s.cacheSize[0];}else{c=u.get("cacheSize");}if(q.isNumeric(c)){c=parseInt(c,10);}else{c=undefined;}if(c&&c>=0){this.iCacheSize=c;}if(s.InstanceID&&s.InstanceID.length>0){this.sTaskInstanceID=s.InstanceID[0];}else{this.sTaskInstanceID=u.get("InstanceID");}if(s.SAP__Origin&&s.SAP__Origin.length>0){this.sSapOrigin=s.SAP__Origin[0];}else{this.sSapOrigin=u.get("SAP__Origin");}if(s.forwardUserSettings&&s.forwardUserSettings.length>0){this.bPropogateSapURLParameters=s.forwardUserSettings[0]=="false"?false:true;}else{this.bPropogateSapURLParameters=u.get("forwardUserSettings")==="false"?false:true;}}else{this._getURLParameters();}},_getURLParameters:function(){var u=U.fromURL(window.location.href);this.sScenarioId=u.get("scenarioId");if(!this.sScenarioId){var t=u.get("taskDefinitions");if(t!=null){this.sClientScenario=decodeURIComponent(t);}}this.bAllItems=u.get("allItems")=="true"?true:!(this.sScenarioId||this.sClientScenario);this.userSearch=u.get("userSearch")=="false"?false:true;this.bOutbox=u.get("outbox")=="true"?true:false;this.tableView=u.get("expertMode")=="true"?true:false;this.tableViewOnPhone=u.get("expertModeOnPhone")=="true"?true:false;this.bSubstitution=u.get("substitution")=="true"?true:false;this.bFullWidth=u.get("fullWidth")=="true"?true:false;this.bShowLog=u.get("showLog")=="false"?false:true;this.bTaskTitleInHeader=u.get("taskTitleInHeader")=="true"?true:false;this.bStandaloneDetailDeep=u.get("standaloneDetailDeep")=="true"?true:false;this.sTaskInstanceID=u.get("InstanceID");this.sSapOrigin=u.get("SAP__Origin");this.bShowAdditionalAttributes=u.get("showAdditionalAttributes")=="true"?true:false;if(u.get("massAction")=="true"){this.bIsMassActionEnabled=true;}else if(u.get("massAction")=="false"){this.bIsMassActionEnabled=false;}if(u.get("quickAction")=="true"){this.bIsQuickActionEnabled=true;}else if(u.get("quickAction")=="false"){this.bIsQuickActionEnabled=false;}this.sDefaultSortBy=u.get("sortBy");var l=u.get("listSize");if(l&&q.isNumeric(l)&&parseInt(l,10)>0){this.iListSize=parseInt(l,10);}var T=u.get("taskObjects");if(T&&T.length>0){this.bShowTaskObjects=T==="true"?true:false;}else{this.bShowTaskObjects=D.system.desktop;}var p=u.get("pageSize");if(p&&q.isNumeric(p)&&parseInt(p,10)>0){this.iPageSize=parseInt(p,10);}var c=u.get("cacheSize");if(q.isNumeric(c)){c=parseInt(c,10);}else{c=undefined;}if(c&&c>=0){this.iCacheSize=c;}this.bEnablePaging=u.get("enablePaging")==="true"?true:false;var o=u.get("operationMode");if(o&&o.toUpperCase()==="CLIENT"){this.sOperationMode="Client";}else{this.sOperationMode="Server";}this.bPropogateSapURLParameters=u.get("forwardUserSettings")==="false"?false:true;},fnUpdateSingleTask:function(s,i,f,e){var t=this;this.oDataRead("/TaskCollection(SAP__Origin='"+a(s)+"',InstanceID='"+a(i)+"')",null,function(d){if(f){f(d);}t.processListAfterAction(s,i);t.fireActionPerformed();t.fnShowReleaseLoader(false);},function(o){if(e){e(o);}t.processListAfterAction(s,i);t.fnShowReleaseLoader(false);t.oDataRequestFailed(o);});},checkPropertyExistsInMetadata:function(p,e){var c=false;if(this.oServiceMetaModel&&this.oServiceMetaModel.oModel&&this.oServiceMetaModel.oModel.oData&&this.oServiceMetaModel.oModel.oData.dataServices&&this.oServiceMetaModel.oModel.oData.dataServices.schema[0]){var n=this.oServiceMetaModel.oModel.oData.dataServices.schema[0].namespace;var t=this.oServiceMetaModel.getODataEntityType(n+"."+(e?e:"Task"));if(!t){t=this.oServiceMetaModel.getODataEntityType(n+".TaskCollection");}if(t){if(this.oServiceMetaModel.getODataProperty(t,p)){c=true;}else{for(var i=0;i<t.navigationProperty.length;i++){if(t.navigationProperty[i].name===p){c=true;break;}}}}}return c;},checkEntitySetExistsInMetadata:function(e){var c=null;if(!this.oServiceMetaModel){return c;}c=this.oServiceMetaModel.getODataEntitySet(e)?true:false;return c;},checkFunctionImportExistsInMetadata:function(f){var e=null;if(!this.oServiceMetaModel){return e;}e=this.oServiceMetaModel.getODataFunctionImport(f)?true:false;return e;},getServiceMetadataNamespace:function(){var n="";if(this.oModel&&this.oModel.getMetaModel()&&this.oModel.getMetaModel().oModel&&this.oModel.getMetaModel().oModel.oData&&this.oModel.getMetaModel().oModel.oData.dataServices&&this.oModel.getMetaModel().oModel.oData.dataServices.schema[0]){n=this.oModel.getMetaModel().oModel.oData.dataServices.schema[0].namespace;}return n;},massReadDecisionOptions:function(t,s){var p=[],d=[],c=[],i;for(var k in t){if(t.hasOwnProperty(k)){i=t[k];c.push({SAP__Origin:i.SAP__Origin,TaskDefinitionID:i.TaskDefinitionID});p.push({SAP__Origin:"'"+a(i.SAP__Origin)+"'",InstanceID:"'"+a(i.InstanceID)+"'"});}}var f=function(o){var g=o.__batchResponses;var T,h,r;for(var j in g){h=g[j];if(h.hasOwnProperty("data")&&h.statusCode>="200"&&h.statusCode<"300"){r=h.data.results;T=c[j];if(r){this.oDecisionOptions[T.SAP__Origin+T.TaskDefinitionID]=r;d.push(r);}}}s(d);};var e=function(o){};this.fireBatch({sPath:this.FUNCTION_IMPORT_DECISIONOPTIONS,aUrlParameters:p,sMethod:"GET",sBatchGroupId:"DecisionOptionsBatch",numberOfRequests:c.length,fnSuccessCallback:f.bind(this),fnErrorCallback:e.bind(this)});},storeTaskDefinitionModel:function(t){this.oTaskDefinitionModel=q.extend(true,[],t);},getTaskDefinitionModel:function(){return this.oTaskDefinitionModel;}});});
