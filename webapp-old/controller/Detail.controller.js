/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["cross/fnd/fiori/inbox/controller/BaseController","cross/fnd/fiori/inbox/model/formatter","sap/ui/model/json/JSONModel","sap/ui/Device","cross/fnd/fiori/inbox/model/models","cross/fnd/fiori/inbox/model/ModelsHelper","sap/m/Button","sap/m/ToolbarSpacer","sap/ui/core/CustomData","cross/fnd/fiori/inbox/util/ResponseOptionsHelper","cross/fnd/fiori/inbox/util/Constants","sap/m/library","sap/base/Log","sap/base/security/URLListValidator","sap/m/MessageBox",],function(B,f,J,D,m,M,a,T,C,R,b,l,L,U,c){"use strict";return B.extend("cross.fnd.fiori.inbox.controller.Detail",{formatter:f,_taskSwitchCount:0,onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("myTasksDetail").attachPatternMatched(this._onDetailMatched,this);this.setModel(m.getTaskDetailModel(),"detailView");m.attachEvent("taskDetailRequestSuccess",null,function(){var i=this.byId("iconTabBar");i.setBusy(false);},this);m.attachEvent("taskDetailRequessError",null,function(){var i=this.byId("iconTabBar");i.setBusy(false);},this);},onExit:function(){this.getRouter().detachRoutePatternMatched(this._onDetailMatched,this);},openDetailDetail:function(){var n=this.getOwnerComponent().getFCLHelper().getNextUIState(2);var s=n.layout;this.oRouter.navTo("myTasksDetailDetail",{SAP__Origin:encodeURIComponent(this.SAP__Origin),InstanceID:encodeURIComponent(this.InstanceID),layout:s},this.bReplaceHistory);},handleFullScreen:function(){var n=this.getModel("fcl").getProperty("/actionButtonsInfo/midColumn/fullScreen");var s=n;this.oRouter.navTo("myTasksDetail",{SAP__Origin:encodeURIComponent(this.SAP__Origin),InstanceID:encodeURIComponent(this.InstanceID),layout:s},this.bReplaceHistory);},handleExitFullScreen:function(){var n=this.getModel("fcl").getProperty("/actionButtonsInfo/midColumn/exitFullScreen");var s=n;this.oRouter.navTo("myTasksDetail",{SAP__Origin:encodeURIComponent(this.SAP__Origin),InstanceID:encodeURIComponent(this.InstanceID),layout:s},this.bReplaceHistory);},handleClose:function(){this.oRouter.navTo("myTasksMaster",null,this.bReplaceHistory);},_onDetailMatched:function(e){var A=e.getParameter("arguments");var d=decodeURIComponent(A.SAP__Origin);var g=decodeURIComponent(A.InstanceID);this.bReplaceHistory=!D.system.phone;this.getModel("parametersModel").setProperty("/showLogButtonPressed",false);this.getModel("parametersModel").setProperty("/showDetailsButtonPressed",false);if((!this.SAP__Origin&&!this.InstanceID)||(this.SAP__Origin!==d||this.InstanceID!==g)){this.SAP__Origin=d;this.InstanceID=g;}else{return;}this._taskSwitchCount++;this.fillTaskDetail();},getItem:function(){var s="TaskCollection(SAP__Origin='"+encodeURIComponent(this.SAP__Origin)+"',InstanceID='"+encodeURIComponent(this.InstanceID)+"')";var o=new sap.ui.model.Context(this.getView().getModel(),s);var i=this.getView().getModel().getData(o.getPath(),o);if(!i){s="TaskCollection(InstanceID='"+encodeURIComponent(this.InstanceID)+"',SAP__Origin='"+encodeURIComponent(this.SAP__Origin)+"')";o=new sap.ui.model.Context(this.getView().getModel(),s);i=this.getView().getModel().getData(o.getPath(),o);}return i;},getTaskDefinition:function(i){var s="TaskDefinitionCollection(SAP__Origin='"+encodeURIComponent(i.SAP__Origin)+"',TaskDefinitionID='"+encodeURIComponent(i.TaskDefinitionID)+"')";var o=new sap.ui.model.Context(this.getView().getModel(),s);var t=this.getView().getModel().getData(o.getPath(),o);return t;},fillTaskDetail:function(){var i=this.getItem();var t=this.getTaskDefinition(i);i.taskSwitchCount=this._taskSwitchCount;i.bAdditionalInformationVisible=false;i.bNoAdditionalInformationMessageVisible=false;i.bPriorityVisible=false;i.bShowCustomAttributesInDetail=false;if(i.Priority){i.bPriorityVisible=true;}if(t){i.TaskDefinitionName=t.TaskName;}if(!i.TaskDefinitionName){i.TaskDefinitionName=this.getResourceBundle().getText("DetailView_HeaderText");}var s=M.getKeyForTaskDefinitionModel({SAP__Origin:i.SAP__Origin,TaskDefinitionID:i.TaskDefinitionID});var d=m.getTaskDefinitionModel().getData();if(d&&d[s]){var r=d[s][b.NP_RESPONSE_OPTIONS_DATA];if(r&&r.length>0){i=jQuery.extend({},i,{ResponseOptions:r});}}this._populateFooterWithButtons(i);m.updateTaskDetailModel(i);this._setShowLogButtonVisibility(i);this._setShowDetailsButtonVisibility(i);var o=m.getTaskDetailModel();var p=[];var g=false;var G=false;if(i.TaskSupports){if(i.TaskSupports.CustomAttributeData){G=true;}}var I=this.byId("iconTabBar");if(g||G){I.setBusyIndicatorDelay(0);I.setBusy(true);var S=["SAP__Origin","InstanceID"],e=[];if(g){e.push("Description");S.push("Description");o.setProperty("/bAdditionalInformationVisible",true);}if(G){e.push("CustomAttributeData");S.push("CustomAttributeData");}p.push("$select="+S.join());if(e.length>0){p.push("$expand="+e.join());}m.refreshTaskDetailModel(this.SAP__Origin,this.InstanceID,p,this.getModel("i18n").getProperty("DetailView_EmptyCustomAttributeLabel"));}else{I.setBusy(false);o.setProperty("/bNoAdditionalInformationMessageVisible",true);}},handleShowLogPress:function(){if(this.byId("showLogButton").getPressed()){this.getModel("parametersModel").setProperty("/showDetailsButtonPressed",false);this._showLogs();}else{m.resetWorkflowLogModel();this.handleNavBackToDetail();}},handleOpenTaskButton:function(){var t=m.getTaskDetailModel();if(t){var u=t.getProperty("/GUI_Link");if(u){if(U.validate(u)){l.URLHelper.redirect(u,true);}else if(U.validate(encodeURI(u))){l.URLHelper.redirect(encodeURI(u),true);}else{c.error(this.getModel("i18n").getProperty("dialog.error.taskExecutionUI"));}}}},handleNavBackToDetail:function(){var n=this.getModel("fcl").getProperty("/actionButtonsInfo/endColumn/closeColumn");var s=encodeURIComponent(n);this.oRouter.navTo("myTasksDetail",{SAP__Origin:encodeURIComponent(this.SAP__Origin),InstanceID:encodeURIComponent(this.InstanceID),layout:s},this.bReplaceHistory);},_showLogs:function(){this.openDetailDetail();},_setShowLogButtonVisibility:function(i){if(i.TaskSupports&&i.TaskSupports.WorkflowLog){this.getModel("parametersModel").setProperty("/showLogButtonVisible",true);}else{this.getModel("parametersModel").setProperty("/showLogButtonVisible",false);}},handleShowDetailsPress:function(){if(this.byId("showDetailsButton").getPressed()){this.getModel("parametersModel").setProperty("/showLogButtonPressed",false);this._showDetails();}else{this.handleNavBackToDetail();}},_setShowDetailsButtonVisibility:function(i){this.getModel("parametersModel").setProperty("/showDetailsButtonVisible",false);},_showDetails:function(){this._openAdditionalTaskDetails();},_openAdditionalTaskDetails:function(){var n=this.getOwnerComponent().getFCLHelper().getNextUIState(2);var s=n.layout;this.oRouter.navTo("additionalTaskDetails",{SAP__Origin:encodeURIComponent(this.SAP__Origin),InstanceID:encodeURIComponent(this.InstanceID),layout:s},this.bReplaceHistory);},_populateFooterWithButtons:function(I){var r=I.ResponseOptions;var o=this.byId("overflowToolbar");o.destroyContent();if(!r||r.length===0){return;}var O=o.getId();new T().placeAt(O);for(var i=0;i<r.length;i++){var d=r[i];var e=new a({text:d.DecisionText,type:"Ghost"}).attachPress(this._onFooterButtonPress.bind(this)).placeAt(O);e.data("oItem",I);var g=new C({key:"DecisionKey",value:d.DecisionKey});e.addCustomData(g);}},_onFooterButtonPress:function(e){var p=e.getSource();var d=p.getCustomData();var i=d[0].getValue();var s=d[1].getValue();var g=p.getProperty("text");R.processCustomAction(s,g,i,undefined,this);}});},true);
